<!DOCTYPE html>
<html lang="en">
<head>
  <title>Studio Script Writer</title>
  <style>
    @font-face {
      font-family: 'OpenDyslexic';
      src: url('lib/libraries/fonts/OpenDyslexic-Regular.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }
    
    body {
      padding-top: 60px;
      /* Remove !important from font-family */
      font-family: Arial, 'OpenDyslexic', sans-serif;
      /*Off-white background colour and dark blue text colour for accessibility */
      background-color: #f8f8f8 !important;
      color: rgb(16, 16, 16) !important;
      line-height: 1.5; /* Increased line space for accessibility */
    }

    .main-content {
      display: none;
      width: device-width;
    }

    table {
      width: 794px !important;
      table-layout: fixed;
      margin: 0 auto;
      background-color: #f8f8f8 !important;
      color: rgb(16, 16, 16) !important;
      border-collapse: separate !important;
      border-spacing: 0;
    }

    /* Header styling */
    thead tr {
      border-radius: 8px;
      overflow: hidden;
    }

    thead tr th:not(:last-child) {
      background-color: #f8f8f8 !important; 
      color: #2c3e50 !important; 
      border-radius: 8px 8px 0 0;
      text-align: center !important;
      vertical-align: middle !important;
      height: 48px !important;
      line-height: 1.5 !important;
      font-weight: 600 !important;
      text-transform: uppercase !important; 
      font-size: 0.9rem !important;
      letter-spacing: 0.5px !important; 
      border-bottom: 2px solid #e2e8f0 !important; 
      box-shadow: 2px 2px 4px rgba(0,0,0,0.05) !important; 
    }

    thead tr th:last-child {
      background-color: #f8f8f8 !important; 
    }

    /* Default cell styling */
    tr td {
      background-color: #f8f8f8 !important;
      color: rgb(16, 16, 16) !important;
    }

    /*--------------------- CELL DESIGN ----------------------*/
    /* Colour of event cells*/
    tr.event_highlighted td:not(:last-child) {
      background-color: rgba(218, 230, 255, 0.3) !important;
      position: relative;
    }
    /* Colour of insert cells*/
    tr.insert_highlighted td:not(:last-child) {
      background-color: rgba(255, 231, 250, 0.5) !important;
      position: relative;
    }
     /* Colour of item cells*/
     tr.item_highlighted td:not(:last-child) {
      background-color: rgba(255, 248, 203, 0.775) !important;
      position: relative;
    }

    /* Styling colour of event cells*/
    tr.event_highlighted::after {
      outline: 2px solid rgba(5, 88, 189, 0.6) !important;
      box-shadow: 0 0 2px rgba(58, 118, 214, 0.3) !important;
    }
    /* Styling colour of insert cells*/
    tr.insert_highlighted::after {
      outline: 2px solid rgba(255, 66, 233, 0.6) !important;
      box-shadow: 0 0 2px rgba(141, 36, 149, 0.3) !important;
    }
    /* Styling colour of item cells*/
    tr.item_highlighted::after {
      outline: 2px solid rgb(255, 221, 0) !important;
      box-shadow: 0 0 2px rgba(250, 222, 41, 0.3) !important;
    }

    /* Remove cell borders */
    tr.event_highlighted td,
    tr.insert_highlighted td,
    tr.item_highlighted td {
      border: none !important; 
    }
    tr.event_highlighted,
    tr.insert_highlighted,
    tr.item_highlighted {
      position: relative;
    }

    /* Hover */
    tr.event_highlighted:hover td:not(:last-child),
    tr.insert_highlighted:hover td:not(:last-child),
    tr.item_highlighted:hover td:not(:last-child),
    tr.insert_highlighted:hover .insert-duration-container {
      background-color: rgba(248, 248, 248, 0.9) !important;
      transition: background-color 0.2s ease;
    }

    /* Structure design of cells*/
    tr.event_highlighted::after,
    tr.insert_highlighted::after,
    tr.item_highlighted::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 90px;
      bottom: 0;
      border-radius: 12px;
      pointer-events: none;
      transition: all 0.2s ease-in-out;
    }

    tr.event_highlighted td:first-child,
    tr.insert_highlighted td:first-child,
    tr.item_highlighted td:first-child {
      border-top-left-radius: 12px;
      border-bottom-left-radius: 12px;
    }

    tr.event_highlighted td:nth-child(4),
    tr.insert_highlighted td:nth-child(4),
    tr.item_highlighted td:nth-child(4) {
      border-top-right-radius: 12px;
      border-bottom-right-radius: 12px;
    }

    /* General editable cell styling */
    .editable-cell,
    .editable-text,
    div[contenteditable='true'] {
        border: 0.5px solid rgb(155, 180, 203);
        border-radius: 8px;
        background-color: rgba(240, 240, 240, 0.3) !important;
        color: rgb(16, 16, 16) !important;
    }

    /* Specific styling for insert cells */
    tr.insert_highlighted .editable-cell,
    tr.insert_highlighted .editable-text,
    tr.insert_highlighted div[contenteditable='true'] {
        background-color: rgba(255, 231, 250, 0.5);
        border: 0px solid rgb(255, 214, 235);
    }

    .table .shot-type-select {
      width: fit-content;
      text-align: left;
      border: 0px solid rgb(214, 235, 255);
      outline: 0.2px solid rgba(61, 113, 255, 0.5);
      background-color: rgba(240, 240, 240, 0.3) !important;
    }

    .shot-type-select option {
      background-color: rgba(218, 237, 255, 0.3) !important;
      color: rgb(16, 16, 16) !important;
    }

    /* -------------------- Nav bar ---------------------------*/
    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    li {
      float: none;
    }

    .nav-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #2c3e50;
        padding: 12px 24px;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .toolbar-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .toolbar-group.left {
        margin-right: auto;
    }

    .toolbar-group.right {
        margin-left: auto;
    }

    .button2 {
        background-color: transparent !important;
        color: #ecf0f1 !important;
        padding: 8px 16px;
        border-radius: 4px;
        border: 1px solid transparent;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .button2:hover {
        background-color: rgba(255,255,255,0.1) !important;
        border-color: rgba(255,255,255,0.2);
    }

    .button2.primary {
        background-color: #3498db !important;
    }

    .button2.primary:hover {
        background-color: #2980b9 !important;
    }

    .button2.warning {
        background-color: #e74c3c !important;
    }

    .button2.warning:hover {
        background-color: #c0392b !important;
    }

   
   
    /* ---------------------------------------------------------*/

    .editable-cell:not(.production-title),
    .editable-text:not(.production-title),
    div[contenteditable='true']:not(.production-title) {
      display: block;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
      min-height: 24px; 
      user-select: text; 
      background-color: rgba(244, 244, 244, 0.3) !important;
      outline: 0px !important;
    }

    .editable-cell span {
      display: inline-block;
      position: relative;
      width: 100%;
    }

    .editable-cell span::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 3px;
      width: 100%;
      height: 1px;
      background-color: black;
      outline: 1px solid blue;
    }

    .cut-line {
      position: relative;
    }
    
    .cut-line::after {
      content: '';
      position: absolute;
      left: -350px !important; 
      right: 0; 
      bottom: -3px;
      height: 2px;
      background-color: black;
      z-index: 1;
      pointer-events: none;
    }

    .shot-type-flex-container {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .shot-type-text {
        flex-grow: 1;
        margin-left: 8px;
    }
    
    .shot-type-dropdown {
        flex-shrink: 0;
        margin-right: 6px; 
    }

    .shotSubject {
        flex: 1; 
        min-width: 0; 
    }

    .modal-dialog {
      margin-top: 15%;
      text-align: center;
    }
    .modal-footer {
      justify-content: center !important;
      text-align: center;
      gap: 15px;
    }

    .highlight {
      background-color: yellow;
    }

    .insert-duration-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        margin: 0 auto;
        text-align: center;
        padding-left: 35px;
        background-color: transparent !important;
        color: rgb(16, 16, 16) !important;
    }

    .insertDuration {
        text-align: right;
        margin: 0;
        padding: 0;
    }

    .view-mode .insert-duration-container {
        display: flex;
        justify-content: center;
        text-align: center;
    }

    .view-mode .insertDuration {
        padding-right: 4px;
    }

    .production-title-container {
        text-align: left;
        padding: 10px 0;
        margin-top: 30px;
        margin-bottom: -80px;
        margin-left: 165px;
    }

    .production-title {
        font-size: 24px;
        font-weight: bold;
        padding: 8px 16px;
        border-radius: 4px;
        display: inline-block;
        background-color: #f8f8f8 !important;
        outline: none !important;
        border: none !important;
        color: rgb(16, 16, 16) !important;
    }

    /* Row action buttons styling */
    .row-actions {
        display: flex;
        gap: 4px;
        justify-content: center;
        align-items: center;
        opacity: 0.6;
        transition: opacity 0.2s ease;
        height: 100%; 
        padding: 8px 0;
    }

    .row-actions:hover {
        opacity: 1;
    }

    /* move/remove buttons */
    td:last-child {
        vertical-align: middle !important; 
        position: relative; 
    }

    .row-button {
        width: 28px;
        height: 28px;
        padding: 0;
        border: none;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        background: transparent;
        color: #2c3e50; 
    }

    .row-button.drag {
        color: #ffffff;
        background-color: #0c0c0c; 
    }

    .row-button.drag:hover {
        background-color: #34ca0b; 
    }

    .row-button.remove {
        color: #ffffff;
        background-color: #0c0c0c;   
    }

    .row-button.remove:hover {
        background-color: #ed0606; 
    }

    .custom-shot-type {
        width: 100%;
        border: 0.5px solid rgb(155, 180, 203);
        border-radius: 8px;
        background-color: rgba(240, 240, 240, 0.3) !important;
        color: rgb(16, 16, 16) !important;
        padding: 2px 6px;
        display: none;
    }

    /* New styles for drag and drop */
    tr.dragging {
        opacity: 0.5;
        background-color: #f0f0f0;
    }
    
    tbody tr {
        cursor: default;  /* Remove the move cursor from rows */
    }

    .row-button.drag {
        cursor: move;  /* Show move cursor only on drag button */
    }

  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
  <!-- Login Form -->
  <div id="login-form" style="text-align:center;">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button id="loginButton">Login</button>
  </div>

  <!-- Project Login Form -->
  <div id="project-login" style="text-align:center;">
    <h2>Project Name:</h2>
    <input type="text" id="projectName" placeholder="Enter Project Name"><br><br>
    <button id="projectLogBtn">Select</button>
  </div>

  <!-- Main Page -->
  <div class="main-content">
    <nav class="nav-toolbar">
        <div class="toolbar-group left">
            <button class="btn button2 undo-button" title="Undo"><i class="fas fa-undo"></i></button>
            <button class="btn button2 redo-button" title="Redo"><i class="fas fa-redo"></i></button>
            <div class="divider"></div>
            <button class="btn button2 bold-button" title="Bold"><i class="fas fa-bold"></i></button>
            <button class="btn button2 italic-button" title="Italic"><i class="fas fa-italic"></i></button>
            <button class="btn button2 underline-button" title="Underline"><i class="fas fa-underline"></i></button>
            <button class="btn button2 highlight-button" title="Highlight"><i class="fas fa-highlighter"></i></button>
            <button class="btn button2 font-button" title="Font"><i class="fas fa-font"></i></button>
        </div>

        <div class="toolbar-group center">
            <button class="btn button2 addEvent-button" title="Add Event"><i class="fas fa-plus"></i> Event</button>
            <button class="btn button2 addInsert-button" title="Add Insert"><i class="fas fa-film"></i> Insert</button>
            <button class="btn button2 addCut-button" title="Add Cut"><i class="fas fa-cut"></i> Cut</button>
            <button class="btn button2 addDur-button" title="Add Duration"><i class="fas fa-clock"></i> Duration</button>
            <button class="btn button2 addItem-button" title="Add Item"><i class="fas fa-list"></i> Item</button> 
        </div>

        <div class="toolbar-group right">
            <button class="btn button2 primary" title="Save"><i class="fas fa-save"></i> Save</button> 
            <button class="btn button2 view-button" title="View"><i class="fas fa-eye"></i> View</button>
            <button class="btn button2 runningOrder-button" title="Running Order"><i class="fas fa-list-ol"></i> Running Order</button>
        </div>
    </nav>

    <div class="production-title-container">
        <div class="production-title" contenteditable="true"></div>
    </div>

    <div class="square"></div>

    <div class="container">
      <table style="margin-top:100px;" id="event-table" class="draggable-table">
          <thead>
              <tr>
                  <th scope="col" style="border: 1px solid black; width:100px; text-align: center;">Event number</th>
                  <th scope="col" style="border: 1px solid black; width:350px; text-align: center;">Shot</th>
                  <th scope="col" style="border: 1px solid black; width:450px; text-align: center;">Script</th>
                  <th scope="col" style="border: 1px solid black; width:150px; text-align: center;">Details</th>
                  <th scope="col" style="border: none; width:90px; text-align: center;"></th>
              </tr>
          </thead>
          <tbody>
          </tbody>
      </table>
    </div>
  </div>

  <!-- Question pop up -->
  <div class="modal fade" id="questionModal" tabindex="-1" role="dialog" aria-labelledby="questionModalLabel" aria-modal="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="questionModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modalOption1"></button>
          <button type="button" class="btn btn-primary" id="modalOption2"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script type="text/javascript">
    //checks if user is already logged in
    window.onload = function() {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const projectName = sessionStorage.getItem('projectName');
        
        if (isLoggedIn === 'true') {
            $('#login-form').hide();
            if (projectName) {
                $('#project-login').hide();
                $('.main-content').show();
                $('.production-title').text(projectName);
                document.title = projectName + ' - Studio Script Writer';
            } else {
                $('#project-login').show();
            }
        }
    };

    function preventDeletion(event, defaultContent) {
      const element = event.target;
      const row = element.closest('tr');
      
      
      //Use setTimeout to get the updated content after the current event cycle
      setTimeout(() => {
        const shotSubject = row.querySelector('.shotSubject');
        const cameraType = row.querySelector('.cameraType');
        const extraInfo = row.querySelector('.extraInfo');

        //Check if any of the cells are empty
        if (shotSubject.textContent.length === 0) {
          //Restore the previous content
          shotSubject.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); //false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }

        if (cameraType.textContent.length === 0) {
          //Restore the previous content
          cameraType.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); //false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }

        if (extraInfo.textContent.length === 0) {
          //Restore the previous content
          extraInfo.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); //false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }
      }, 0);
          
          
    }
    

    var role;
    $('#project-login').hide();

    document.getElementById('loginButton').addEventListener('click', function() {
      login();
    });

    document.getElementById('projectLogBtn').addEventListener('click', function() {
      projectLogin();
    });

    function login() {
      const usernameInput = document.querySelector("#username");
      const passwordInput = document.querySelector("#password");

      function usernameCheck(json_file) { //A json file needs to be passed in
          fetch(json_file, {method: 'GET'}) //Get the file
              .then(response => response.json()) //Put them in json format
              .then(result => {
                  const usernameList = result.usernames.map(element => {
                      return element.toLowerCase() //Turns it to lower case
                  })

                  const passwordList = result.passwords.map(element => {
                    return element.toLowerCase() //Turns it to lower case
                  })

                  const targetUsername = usernameInput.value.toLowerCase();
                  const targetPassword = passwordInput.value.toLowerCase();
                  let authenticated = false;

                  for(let i = 0; i < usernameList.length; i++) {
                      if(targetUsername === usernameList[i] && targetPassword === passwordList[i]) {
                          $('#login-form').hide();
                          $('#project-login').show();
                          authenticated = true;
                          //Add these lines to store login state
                          sessionStorage.setItem('isLoggedIn', 'true');
                          sessionStorage.setItem('username', targetUsername);
                          break;
                      }
                  }

                  if(!authenticated) {
                    alert("Username or password is incorrect");
                  } 
              })
              .catch(error => console.log("Error", error)) //Error handling
          }
        
        var username = document.getElementById('username').value;
        var password = document.getElementById('password').value;
    
        usernameCheck("userPass.json"); //Use the function above
    }

    function projectLogin() {
      var projectName = document.getElementById('projectName').value;

      function projectCheck(json_file) {
        fetch(json_file, {method: 'GET'})
            .then(response => response.json())
            .then(result => {
              const projectList = result.productions.map(element => {
                  return element 
              })
              const targetProject = projectName.toLowerCase();
              
              let authenticated = false;

              for(let i = 0; i < projectList.length; i++) {
                if(targetProject === projectList[i]['name'] && projectList[i]['users'].includes(document.getElementById('username').value)) {
                    $('#project-login').hide();
                    $('.main-content').show();
                    $('.production-title').text(projectName);
                    document.title = projectName + ' - Studio Script Writer';
                    authenticated = true;
                    sessionStorage.setItem('projectName', targetProject);
                    break;
                }
              }

              if(!authenticated) {
                alert("Production does not exist or you do not have access");
              } 
            })
            .catch(error => console.log("Error", error))
        }

        projectCheck("productions.json");
    }
    
    $(document).ready(function() {
        var highlight = true;
        var cutLine = true;

        var tableData = [
            { eventNum: '1', shotType: '', content: 'Add your script here and add an extra line', details: 'E.g., Music Cues' },
        ];

        var dropdownOptions = ['SHOT TYPE', 'ES', 'WS', '2S', '3S', 'MS', 'MCU', 'CU', 'ECU', 'AS DIRECTED',  'CUSTOM'];
        

        //CREATE SHOT TYPE CELL
        function createShotTypeCell(shotType, firstTime) {
            var selectHTML = `
                <div class="shot-type-wrapper">
                    <select class="form-control shot-type-select">
                        ${dropdownOptions.map(option => `
                            <option value="${option}" ${(option === shotType) ? 'selected' : ''}>${option}</option>
                        `).join('')}
                    </select>
                    <input type="text" class="custom-shot-type" style="display:none">
                </div>`;

            var placeHolderText1 = firstTime ? 'Camera Number/Position' : '\u00A0';
            var placeHolderText2 = firstTime ? 'Shot Subject (E.g., HOST)' : '\u00A0';
            var placeHolderText3 = firstTime ? 'Additional Info (E.g., TRACK OUT)' : '\u00A0';

            return '<div>' +
                '<div class="editable-cell cameraType event_highlighted" contenteditable="true" onkeydown="preventDeletion(event, \'' + placeHolderText1 + '\')">' + placeHolderText1 + '</div>' +
                '<div class="shot-type-flex-container event_highlighted">' +
                    '<div class="shotTypeDropdown">' + selectHTML + '</div>' +
                    '<div class="editable-text shotSubject" contenteditable="true" onkeydown="preventDeletion(event, \'' + placeHolderText2 + '\')" >' + placeHolderText2 + '</div>' +
                '</div>' +
                '<div class="editable-cell extraInfo event_highlighted" contenteditable="true" onkeydown="preventDeletion(event, \'' + placeHolderText3 + '\')">' + placeHolderText3 + '</div>' +
            '</div>';
        }

        //CREATE INSERT CELL
        function createInsertCell() {
          var placeHolderText1 = 'Ven: TITLES';
          var placeHolderText2 = 'In: Music';
          var placeHolderText3 = 'Dur: ';
          var placeHolderText4 = 'Out: Music';

          return '<div>' +
            '<u><div class="editable-cell insertTitle"; style="text-align:center; outline: none;" contenteditable="true" onkeydown="preventDeletion(event, \'' + placeHolderText1 + '\')">' + placeHolderText1 + '</u></div>' +
            '<div class="editable-text insertIn"; style="text-align:center; outline: none; padding-right: 10px;" contenteditable="true" onkeydown="preventDeletion(event, \'' + placeHolderText2 + '\')" >' + placeHolderText2 + '</div>' +
            '<div class="insert-duration-container">' +
                '<span class="insertDuration">' + placeHolderText3 + '</span>' +
                '<input type="time" id="durationVT" name="durationVT" style="border: none; width: auto;">' +
            '</div>' +
            '<div class="editable-cell insertOut"; style="text-align:center; outline: none;" contenteditable="true" onkeydown="preventDeletion(event, \'' + placeHolderText4 + '\')">' + placeHolderText4 + '</div>' +
          '</div>';
        }

        //CREATE ITEM CELL
        function createItemCell() {
          const currentItemCount = $('#event-table tbody tr.item_highlighted').length + 1;
          return '<b><u>ITEM ' + currentItemCount + ':</b><span contenteditable="true" class="item-content"> New Item</u></span>';
        }

        //UPDATE EVENT NUMBERS AND HIGHLIGHTING
        function updateEventNumbers() {
          let eventNumber = 1;
          $('#event-table tbody tr').each(function() {
              //Check if there is an event in the row (If Shot column or Insert has content)
              const hasEvent = $(this).find('td:nth-child(2)').text().trim().length > 0;
              const hasInsert = $(this).find('td:nth-child(3)').text().trim().length > 0;
              const isItem = $(this).hasClass('item_highlighted');
              
              if ((hasEvent || hasInsert) && !isItem) {  // Only number non-item rows
                  $(this).find('td:first').text(eventNumber);
                  eventNumber++;
              } else {
                  $(this).find('td:first').text('');  // Clear the number for items
              }
          });
        }

        //UPDATE ITEM NUMBERS - Modified to preserve formatting
        function updateItemNumbers() {
          let itemNumber = 1;
          $('#event-table tbody tr.item_highlighted').each(function() {
              const itemCell = $(this).find('td:nth-child(3)');
              const currentText = itemCell.html();
              // Split at the colon and preserve any HTML formatting
              const colonIndex = currentText.indexOf(':');
              const content = colonIndex !== -1 ? currentText.substring(colonIndex + 1) : currentText;
              // Create new text with formatting preserved
              const newText = `<b><u>ITEM ${itemNumber}:</u></b>${content}`;
              itemCell.html(newText);
              itemNumber++;
          });
        }


        function createRowButtons() {
            const buttons = `<div class="row-actions">
                <button class="row-button drag" title="Drag Row">
                    <i class="fas fa-grip-vertical"></i>
                </button>
                <button class="row-button remove" title="Remove Row">
                    <i class="fas fa-minus"></i>
                </button>
            </div>`;
            return buttons;
        }

        // Update the table row creation code
        function createTableRow(type = 'default') {
            return `<tr class="${type}_highlighted">
                <td contenteditable="true" style="text-align:center"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true" style="text-align:center"></td>
                <td style="border:none; width:90px">${createRowButtons()}</td>
            </tr>`;
        }

        // Populate the table with data on document ready
        tableData.forEach(function(row) {
            var newRow = `<tr class="item_highlighted">
                <td contenteditable="true" style="text-align:center"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true">${createItemCell()}</td>
                <td contenteditable="true" style="text-align:center"></td>
                <td style="border:none; width:90px">${createRowButtons()}</td>
            </tr>`;
            $('#event-table tbody').append(newRow);
        });

        $(document).on('click', '.row-button.remove', function() {
            if ($('#event-table tbody tr').length > 1) {
                $(this).closest('tr').remove();
                updateEventNumbers();
                updateItemNumbers();
                initDraggable(); // Reinitialize draggable after removing a row
            }
        });

        //ADD EVENT 
        $('.addEvent-button').on('click', function() {
            var selection = window.getSelection();
            var targetRow;

            if (selection.rangeCount > 0) {
                var range = selection.getRangeAt(0);
                //First try to find the closest td, then find its parent tr
                var cell = range.commonAncestorContainer.nodeType === 1 
                    ? range.commonAncestorContainer.closest('td')?.closest('tr')
                    : range.commonAncestorContainer.parentElement.closest('td')?.closest('tr');
                if (cell) {
                    targetRow = $(cell);
                    var newRow = $('<tr class="event_highlighted">' +
                        '<td contenteditable="true" style="text-align:center"></td>' +
                        '<td contenteditable="true">' + createShotTypeCell("SHOT TYPE", false) + '</td>' +
                        '<td contenteditable="true"></td>' +
                        '<td contenteditable="true" style="text-align:center"></td>' +
                        '<td style="border:none; width:90px">' + createRowButtons() + '</td>' +
                        '</tr>');
                    
                    newRow.insertAfter(targetRow);
                    updateEventNumbers();
                    initDraggable(); //Make it draggable
                    return;
                }
            }

            //If no selection, create new row at the end
            var newRow = '<tr class="event_highlighted">' +
                '<td contenteditable="true"; style="text-align:center";></td>' +
                '<td contenteditable="true";>' + createShotTypeCell("SHOT TYPE", false) + '</td>' +
                '<td contenteditable="true"></td>' +
                '<td contenteditable="true"; style="text-align:center";></td>' +
                '<td style="border:none; width:90px">' + createRowButtons() + '</td>' +
                '</tr>';
            $('#event-table tbody').append(newRow);
            updateEventNumbers();
            
            // Initialize draggable on the newly added row
            initDraggable();
        });

        //UNDERLINE
        $('.underline-button').on('click', function() {
          document.execCommand('underline', false, null);
        });

        //BOLD
        $('.bold-button').on('click', function() {
          document.execCommand('bold', false, null);
        });

        //ITALIC
        $('.italic-button').on('click', function() {
          document.execCommand('italic', false, null);
        });

        //FONT
        $('.font-button').on('click', function() {
            const body = document.body;
            const currentFont = window.getComputedStyle(body).fontFamily;
            
            //Toggle between Arial and Opendyselxic
            if (currentFont.includes('OpenDyslexic')) {
                body.style.setProperty('font-family', 'Arial, sans-serif', 'important');
                localStorage.setItem('preferredFont', 'Arial');
            } else {
                body.style.setProperty('font-family', 'OpenDyslexic, Arial, sans-serif', 'important');
                localStorage.setItem('preferredFont', 'OpenDyslexic');
            }
        });

        //ADD CUT ON CLICK
        $('.addCut-button').on('click', function() {
            const selection = window.getSelection();
            let lineCount = 1; //Default to 1

            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const rects = range.getClientRects();
                
                //Get all unique y-coordinates of the rectangles
                const uniqueYPositions = new Set();
                for (const rect of rects) {
                    uniqueYPositions.add(Math.round(rect.top)); //Round to handle minor pixel differences
                }
                
                lineCount = uniqueYPositions.size;

                //Get the cell containing the selection
                const cell = range.commonAncestorContainer.nodeType === 1 
                    ? range.commonAncestorContainer.closest('td')
                    : range.commonAncestorContainer.parentElement.closest('td');

                if (cell) {
                    const row = cell.closest('tr');
                    const shotCell = row.querySelector('td:nth-child(2)');
                    
                    //Move down the shot type cell to align with cut line
                    if (shotCell) {
                        // Get the script cell (3rd column) content
                        const scriptCell = row.querySelector('td:nth-child(3)');
                        const scriptContent = scriptCell ? scriptCell.textContent : '';
                        const characterCount = scriptContent.length;

                        const charactersPerLine = 60; //Characters per line
                        const lineHeight = 24; //Pixels per line

                        //How many lines to move the shot cell down by
                        const offset = lineHeight * Math.floor(characterCount / charactersPerLine);

                        //Make shot row and highlighted cut line up
                        const allElements = shotCell.querySelectorAll('.editable-cell, .shot-type-flex-container');
                        allElements.forEach(element => {
                            element.style.position = 'relative';
                            element.style.top = `${offset}px`;
                        });
                        
                        // Extend the row height
                        const cells = row.querySelectorAll('td');
                        cells.forEach(cell => {
                            cell.style.height = `${offset + 100}px`; // Add extra padding
                            cell.style.verticalAlign = 'top';
                        });
                    }
                }
            }

            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const cell = range.commonAncestorContainer.nodeType === 1 
                ? range.commonAncestorContainer.closest('td')
                : range.commonAncestorContainer.parentElement.closest('td');
                
            if (!cell || cell.cellIndex !== 2) return;

            const selectedText = selection.toString();
            const existingCutLine = cell.querySelector('.cut-line');

            function createCutLine(text) {
                const span = document.createElement('span');
                span.className = 'cut-line';
                span.textContent = text;
                return span;
            }

            function addSlashAfter(element) {
                const textNode = document.createTextNode(" / ");
                element.after(textNode);
                return textNode;
            }

            function moveCursorAfter(node) {
                const newRange = document.createRange();
                newRange.setStartAfter(node);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }

            if (existingCutLine) {
                showQuestionModal(
                    "Remove or Add new event?", //question
                    "Remove", //option 1
                    "Add new event", //option 2

                    //REMOVE
                    function() {
                      var selection = window.getSelection();
                      var range = selection.getRangeAt(0);
                      var newText = selection.toString();
                      //Removes the '/' cut within the highlight
                      newText = newText.replace(/ \/ /g, ' ').trim();           

                      //Get the cell containing the selection
                      const cell = range.commonAncestorContainer.nodeType === 1 
                          ? range.commonAncestorContainer.closest('td')
                          : range.commonAncestorContainer.parentElement.closest('td');
                      
                      //Find and remove the existing cut line
                      const existingCutLine = cell.querySelector('.cut-line');
                      if (existingCutLine) {
                        //Remove the cut line and the following slash
                        const nextNode = existingCutLine.nextSibling;
                        if (nextNode && nextNode.nodeType === Node.TEXT_NODE && nextNode.textContent.includes('/')) {
                          nextNode.remove();
                        }
                        existingCutLine.remove();
                      }
                    },
                    //ADD TO NEW EVENT
                    function() {
                        const selectedText = selection.toString();

                        $('.addEvent-button').trigger('click');
                        updateEventNumbers();

                        const newRow = cell.closest('tr').nextElementSibling;
                        const newScriptCell = newRow.cells[2];

                        const cutLineSpan = createCutLine(selectedText);
                        newScriptCell.appendChild(cutLineSpan);
                        addSlashAfter(cutLineSpan);

                        range.deleteContents();
                        if (cell.textContent.trim() === '') {
                            cell.textContent = '';
                        }
                    }
                );
            } else {
                try {
                    const newSpan = createCutLine(selectedText);
                    range.deleteContents();
                    range.insertNode(newSpan);
                    const textNode = addSlashAfter(newSpan);
                    moveCursorAfter(textNode);
                } catch (e) {
                    console.log("Could not add cut line: Selection may be invalid");
                }
            }
        });

        //ADD DURATION
        $('.addDur-button').on('click', function() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const timeInput = $('<input type="time" style="border: none; width: auto;">');
            range.deleteContents();
            range.insertNode(timeInput[0]);
            timeInput.focus();
        });

        //UNDO
        $('.undo-button').on('click', function() {
          document.execCommand('undo', false, null);
        });

        //REDO
        $('.redo-button').on('click', function() {
          document.execCommand('redo', false, null);
        });


        //VIEW MODE
        $('.view-button').on('click', function() {
            const tableClone = $('.container').clone();
            const productionTitle = $('.production-title').text(); // Get the production title
            
            //Show dropdown as the selected value
            const originalSelects = $('.container .shot-type-select');
            tableClone.find('.shot-type-select').each(function(index) {
                const originalSelect = originalSelects.eq(index);
                const selectedText = originalSelect.find('option:selected').text();
                if(selectedText === 'CUSTOM') {
                    // If dropdown is CUSTOM then display the inserted text or default
                    const customValue = originalSelect.siblings('.custom-shot-type').val();
                    $(this).replaceWith($('<span>').text(customValue || ' '));
                } 
                // If no selection, display blank with margins for the structure
                if(selectedText === "SHOT TYPE") {
                  $(this).replaceWith($('<span style="margin: 40px;">').text(''));
                }
                // Otherwise, dusplay what the user selected
                else {
                    $(this).replaceWith($('<span>').text(selectedText));
                }
            });

            //Remove editable custom cell from shot column
            tableClone.find('td:nth-child(2) .custom-shot-type').each(function() {
                const content = $(this).text().trim();
                $(this).replaceWith($('<span>').text(' '));
            });
            
            //Make all contenteditable elements non-editable in view mode
            tableClone.find('[contenteditable="true"]').attr('contenteditable', 'false');

            //Make all duration elements uneditable strings
            tableClone.find('input[type="time"]').each(function() {
                const timeValue = $(this).val() || '00:00';
                const [minutes, seconds] = timeValue.split(':');
                $(this).replaceWith($('<span>').text(`${minutes}'${seconds}"`));
            });
            
            //Create new window/tab and write content
            const viewWindow = window.open('', '_blank');
            viewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>View Mode</title>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
                    <style>
                        body { 
                            padding-top: 20px;
                        }
                        table {
                            width: 794px !important;
                            table-layout: fixed;
                            margin: 0 auto;
                        }  
                        td, th{
                            border: none !important;
                            outline: none !important;
                        }
                        .editable-cell,
                        .editable-text,
                        div[contenteditable] {
                            outline: none !important;
                            border: none !important;
                            min-height: 24px;
                        }
                        .shot-type-select {
                            border: none !important;
                            outline: none !important;
                            appearance: none;
                            background: none;
                            pointer-events: none;
                        }
                        .btn {
                            display: none;
                        }
                        .cut-line {
                            position: relative;
                        }
                        .cut-line::after {
                            content: '';
                            position: absolute;
                            left: -350px;
                            right: 0;
                            bottom: -3px;
                            height: 2px;
                            background-color: black;
                            z-index: 1;
                            pointer-events: none;
                        }
                        .shot-type-flex-container {
                            display: flex;
                            align-items: center;
                            gap: 2px; 
                        }
                        .shot-type-flex-container2 {
                            display: flex;
                            align-items: center;
                            gap: 0.5px; 
                        }
                        .shot-type-text {
                            flex-grow: 1;
                            margin-left: 8px;
                        }
                        .shotTypeDropdown {
                            flex-shrink: 0;
                            margin-right: 4px;
                        }
                        .insert-duration-container {
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            text-align: center;
                            margin: 0 auto;
                        }
                        .insert-duration-container > * {
                            display: inline-block;
                            vertical-align: middle;
                            margin: 0;
                        }
                        .insertDuration {
                            padding-right: 4px !important;
                            text-align: right !important;
                        }
                        .production-title {
                            text-align: left;
                            font-size: 24px;
                            font-weight: bold;
                            padding: 8px 16px;
                            margin-top: 100px;
                            margin-bottom: -75px;
                            margin-left: 250px;
                            outline: none !important;
                            border: none !important;
                        }
                    </style>
                </head>
                <body class="view-mode">
                    <div class="production-title">${productionTitle}</div>
                    ${tableClone.html()}
                </body>
                </html>
            `);
            
            //Remove the last column (the add/remove buttons)
            viewWindow.document.querySelectorAll('tr').forEach(row => {
                const lastCell = row.lastElementChild;
                if (lastCell) {
                    lastCell.remove();
                }
            });

            //Remove the text in the header
            viewWindow.document.querySelectorAll('th').forEach(header => {
                header.textContent = '';
            });
            
            viewWindow.document.close();
        });

      //ADD INSERT
      $('.addInsert-button').on('click', function() {
            var selection = window.getSelection();
            var targetRow;

            if (selection.rangeCount > 0) {
                var range = selection.getRangeAt(0);
                //First try to find the closest td, then find its parent tr
                var cell = range.commonAncestorContainer.nodeType === 1 
                    ? range.commonAncestorContainer.closest('td')?.closest('tr')
                    : range.commonAncestorContainer.parentElement.closest('td')?.closest('tr');
                if (cell) {
                    targetRow = $(cell);
                    var newRow = $('<tr class="insert_highlighted">' +
                        '<td contenteditable="true" style="text-align:center"></td>' +
                        '<td contenteditable="true" style="text-align:center"></td>' +
                        '<td contenteditable="true">' + createInsertCell() + '</td>' +
                        '<td contenteditable="true" style="text-align:center"></td>' +
                        '<td style="border:none; width:90px">' + createRowButtons() + '</td>' +
                        '</tr>');
                    
                    newRow.insertAfter(targetRow);
                    updateEventNumbers();
                    initDraggable(); //Make it draggable
                    return;
                }
            }

            //If no selection, create new row at the end
            var newRow = '<tr class="insert_highlighted">' +
                '<td contenteditable="true"; style="text-align:center";></td>' +
                '<td contenteditable="true"; style="text-align:center";></td>' +
                '<td contenteditable="true">' + createInsertCell() + '</td>' +
                '<td contenteditable="true"; style="text-align:center";></td>' +
                '<td style="border:none; width:90px">' + createRowButtons() + '</td>' +
                '</tr>';
            $('#event-table tbody').append(newRow);
            updateEventNumbers();
            
            // Initialize draggable on the newly added row
            initDraggable();
        });


      //ADD ITEM
      $('.addItem-button').on('click', function() {
        var selection = window.getSelection();
        var targetRow;
        
        //If there is a selection, add an item cell to the target row
        if (selection.rangeCount > 0) {
            var range = selection.getRangeAt(0);
            var cell = range.commonAncestorContainer.nodeType === 1 
                ? range.commonAncestorContainer.closest('td')?.closest('tr')
                : range.commonAncestorContainer.parentElement.closest('td')?.closest('tr');
            if (cell) {
                targetRow = $(cell);
                var newRow = $('<tr>').addClass('item_highlighted')
                    .append($('<td>').attr('contenteditable', 'true').css('text-align', 'center'))
                    .append($('<td>').attr('contenteditable', 'true').css('text-align', 'center'))
                    .append($('<td>').attr('contenteditable', 'true').html('<b><u>' + createItemCell() + '</u></b>'))
                    .append($('<td>').attr('contenteditable', 'true').css('text-align', 'center'))
                    .append($('<td>').css('border', 'none').css('width', '90px').html(createRowButtons()))
                newRow.insertAfter(targetRow);
                updateItemNumbers();
                initDraggable();
                return;
            }
        }

        //If there is no selection, create new row with formatted item
        $('#event-table tbody').append(
            $('<tr>').addClass('item_highlighted')
                .append($('<td>').attr('contenteditable', 'true').css('text-align', 'center'))
                .append($('<td>').attr('contenteditable', 'true').css('text-align', 'center'))
                .append($('<td>').attr('contenteditable', 'true').html('<b><u>' + createItemCell() + '</u></b>'))
                .append($('<td>').attr('contenteditable', 'true').css('text-align', 'center'))
                .append($('<td>').css('border', 'none').css('width', '90px').html(createRowButtons()))
        );
        updateItemNumbers();
        initDraggable();
      });

      //UPDATE ITEM NUMBERS - Modified to preserve formatting
      function updateItemNumbers() {
          let itemNumber = 1;
          $('#event-table tbody tr.item_highlighted').each(function() {
              const itemCell = $(this).find('td:nth-child(3)');
              const currentText = itemCell.html();
              // Split at the colon and preserve any HTML formatting
              const colonIndex = currentText.indexOf(':');
              const content = colonIndex !== -1 ? currentText.substring(colonIndex + 1) : currentText;
              // Create new text with formatting preserved
              const newText = `<b><u>ITEM ${itemNumber}:</u></b>${content}`;
              itemCell.html(newText);
              itemNumber++;
          });
      }

       

      // //SAVE
      // $('.save-button').on('click', function() {
        
      // });
          
    });



    // RUNNING ORDER
    $(document).on('click', '.runningOrder-button', function() { 
        const showScriptButton = $('<button class="btn button2" title="Show Script"><i class="fas fa-list-ol"></i> Show Script</button>');
        
        //Store the original content
        const originalContent = $('.container').html();
        
        //Store all duration input values
        const durationValues = {};
        $('.container input[type="time"]').each(function(index) {
            durationValues[index] = $(this).val();
        });

        //Event > Item numbers
        const eventNumbers = [];
        const itemNumbers = [];
        const sourceType = [];
        const soundSource = [];
        const itemLength = [];
        const accumulatedTime = [];
        const timeStore = [];
        const itemTitle = [];
        let accumulatedCalc = 0;

        function wordCalulation(content) {
          const wordCount = content.trim().split(' ').length;
          const wordsPerSecond = 2.5; //Average words per second
          const totalSeconds = wordCount * wordsPerSecond;
          return timeConvert(totalSeconds);
        }

        function secondCalc(time) {
          const timeString = String(time).trim();
          const timeFormat = timeString.split(':');
          const minutes = parseInt(timeFormat[0], 10);
          const seconds = parseInt(timeFormat[1], 10);
          const totalSeconds = minutes * 60 + seconds;
          return totalSeconds;
        }

        function timeConvert(time) {
          const totalSeconds = Math.round(time);
          const minutes = Math.floor(totalSeconds / 60);
          const seconds = totalSeconds % 60;
          return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        let currentItem = null;

        // First, find all item rows and their indices
        const itemRows = [];
        $('#event-table tbody tr').each(function(index) {
            if ($(this).hasClass('item_highlighted')) {
                itemRows.push({
                    index: index,
                    itemNumber: $(this).find('td:nth-child(3)').text().match(/ITEM\s+(\d+)/i)?.[1]
                });
            }
        });

        //Process rows between each pair of items
        for (let i = 0; i < itemRows.length; i++) {
            const currentItem = itemRows[i];
            const nextItem = itemRows[i + 1];
            const startIndex = currentItem.index + 1;
            const endIndex = nextItem ? nextItem.index : $('#event-table tbody tr').length;

            //Get the item title and push it into the list
            const itemContent = $('#event-table tbody tr').eq(currentItem.index).find('td:nth-child(3)').text().trim();
            const contentMatch = itemContent.match(/ITEM\s+\d+:(.*)/i);
            const itemNum = parseInt(currentItem.itemNumber) - 1;
            itemTitle[itemNum] = contentMatch ? contentMatch[1].trim() : '';
            itemNumbers.push(currentItem.itemNumber); 
            
            //Initialize aggregated time for this item
            let totalSeconds = 0;
            let hasVT = false;

            //Process all rows between current item and next item (or end of table)
            for (let j = startIndex; j < endIndex; j++) {
                const row = $('#event-table tbody tr').eq(j);
                const hasEvent = row.find('td:nth-child(2)').text().trim().length > 0;
                const hasInsert = row.find('input[type="time"]').length > 0;

                if (hasEvent) {
                    // Calculate timing based on word count for events
                    const scriptCell = row.find('td:nth-child(3)');
                    const content = scriptCell.clone()
                        .find('.cut-line').remove().end()
                        .text()
                        .trim();
                    
                    const wordCount = content ? content.split(' ').length : 0;
                    const wordsPerSecond = 2.5;
                    totalSeconds += wordCount * wordsPerSecond;
                } else if (hasInsert) {
                    hasVT = true;
                    // Add insert duration
                    const durationInput = row.find('input[type="time"]');
                    if (durationInput.length > 0 && durationInput.val()) {
                        const [minutes, seconds] = durationInput.val().split(':');
                        totalSeconds += parseInt(minutes) * 60 + parseInt(seconds);
                    }
                }
            }

            // Push aggregated data for this item
            sourceType.push(hasVT ? "VT" : "CAMS");
            soundSource.push(hasVT ? "VT" : "");
            itemLength.push(timeConvert(totalSeconds));
        }

        function accumulatedTimeCalc() {
          for(let i = 0; i < itemLength.length; i++) {
            if(i == 0) {
              accumulatedTime.push(timeConvert(secondCalc(itemLength[i])));
            } else {
              accumulatedTime.push(timeConvert(secondCalc(itemLength[i]) + secondCalc(accumulatedTime[i-1])));
            }
          }
       }

        accumulatedTimeCalc();
        
        $('.container').html(`
            <table style="margin-top:100px; text-align:center;" id="runningOrder-table" class="table">
                <thead>
                    <tr>
                        <th style="width:8%;">ITEM NUM.</th>
                        <th style="width:12%;">SOURCE</th>
                        <th style="width:40%;">CONTENT</th>
                        <th style="width:20%;">SOUND</th>
                        <th style="width:10%;">ITEM TIME</th>
                        <th style="width:10%;">ACC. TIME</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemNumbers.map(num => `
                        <tr>
                            <td contenteditable="false">${num}</td>
                            <td contenteditable="true">${sourceType[num-1]}</td>
                            <td contenteditable="true">${itemTitle[num-1]}</td>
                            <td contenteditable="true">${soundSource[num-1]}</td>
                            <td contenteditable="false">${itemLength[num-1]}</td>
                            <td contenteditable="false">${accumulatedTime[num-1]}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `);

        //Remove any existing show script buttons first
        $('.toolbar-group .showScript-button').remove();
        
        //Remove the running order button
        $('.runningOrder-button').remove();
        
        //Attach click handler to show script button
        showScriptButton.on('click', function() {
            //Store the script content
            const runningOrderContent = $('#runningOrder-table').html();
            $('.container').html(originalContent);
            
            //Restore duration input values
            $('.container input[type="time"]').each(function(index) {
                if (durationValues[index]) {
                    $(this).val(durationValues[index]);
                }
            });

            $(this).remove(); //Remove this show script button
            
            //Add back the running order button
            const runningOrderButton = $('<button class="btn button2 runningOrder-button" title="Running Order"><i class="fas fa-list-ol"></i> Running Order</button>');
            $('.toolbar-group.right').append(runningOrderButton);
        });

        //Add the show script button
        $('.toolbar-group.right').append(showScriptButton);
    });
        


    //Pop up question modal
    function showQuestionModal(question, option1Text, option2Text, option1Callback, option2Callback) {
      const modalElement = document.getElementById('questionModal');
      const modal = new bootstrap.Modal(modalElement);
      
      //Set the question
      document.querySelector('#questionModal .modal-body').textContent = question;
      
      //Set button text
      const option1Button = document.getElementById('modalOption1');
      const option2Button = document.getElementById('modalOption2');
      option1Button.textContent = option1Text;
      option2Button.textContent = option2Text;
      
      //Store the element that had focus before opening the modal
      const previousActiveElement = document.activeElement;
      
      //Set up button click handlers
      option1Button.onclick = function() {
        modal.hide();
        option1Callback();
        //Return focus to the previous element
        if (previousActiveElement) {
          previousActiveElement.focus();
        }
      };
      option2Button.onclick = function() {
        modal.hide();
        option2Callback();
        //Return focus to the previous element
        if (previousActiveElement) {
          previousActiveElement.focus();
        }
      };
      
      //Handle modal events
      modalElement.addEventListener('hidden.bs.modal', function () {
        //Return focus to the previous element when modal is hidden
        if (previousActiveElement) {
          previousActiveElement.focus();
        }
      }, { once: true });
      
      modal.show();
    }

    function formatTime(event) {
        //Allow only numbers, backspace, delete, tab, arrows, and colon
        if (!(['0','1','2','3','4','5','6','7','8','9','Backspace','Delete','Tab','ArrowLeft','ArrowRight',':'].includes(event.key))) {
            event.preventDefault();
            return false;
        }
    }

    function formatTimeInput(element) {
        let value = element.textContent.replace(/[^\d]/g, ''); //Remove non-digits
        
        //Pad with zeros if necessary
        while (value.length < 4) {
            value = '0' + value;
        }
        
        //Limit to 4 digits
        value = value.slice(0, 4);
        
        //Format as MM:SS
        const minutes = value.slice(0, 2);
        const seconds = value.slice(2, 4);
        
        //Validate seconds
        if (parseInt(seconds) > 59) {
            element.textContent = minutes + ':59';
        } else {
            element.textContent = minutes + ':' + seconds;
        }
    }

    // If CUSTOM option selected on dropdown, insert an editable cell instead
    $(document).on('change', '.shot-type-select', function() {
        const select = $(this);
        const input = select.siblings('.custom-shot-type');
        if (select.val() === 'CUSTOM') {
            select.hide();
            input.show().focus();
        }
    });

    // Event handler for the CUSTOM input
    $(document).on('blur', '.custom-shot-type', function() {
        const input = $(this);
        const select = input.siblings('.shot-type-select');
        if (!input.val().trim()) {
            input.hide();
            select.show().val('SHOT TYPE');
        }
    });

    // Add drag and drop function
    function initDraggable() {
        const tbody = document.querySelector('#event-table tbody');
        
        // Enable drag only on drag buttons
        tbody.querySelectorAll('.row-button.drag').forEach(button => {
            const row = button.closest('tr');
            
            // Make the drag button the drag handle
            button.draggable = true; // Make the button draggable instead of the row
            
            // Handle drag events on the button
            button.addEventListener('dragstart', (e) => {
                row.classList.add('dragging');
                e.dataTransfer.setData('text/plain', '');
                // Prevent text selection
                e.dataTransfer.effectAllowed = 'move';
            });
            
            button.addEventListener('dragend', () => {
                row.classList.remove('dragging');
                // Update event and item numbers after drag
                updateEventNumbers();
                updateItemNumbers();
            });
        });
        
        tbody.addEventListener('dragover', e => {
            e.preventDefault();
            const draggingRow = tbody.querySelector('.dragging');
            if (!draggingRow) return;
            
            const siblings = [...tbody.querySelectorAll('tr:not(.dragging)')];
            const nextSibling = siblings.find(sibling => {
                const box = sibling.getBoundingClientRect();
                return e.clientY < box.top + box.height / 2;
            });
            
            if (nextSibling) {
                tbody.insertBefore(draggingRow, nextSibling);
            } else {
                tbody.appendChild(draggingRow);
            }
        });
    }

    //Initialize draggable on page load
    initDraggable();
    
    //Make rows remain draggable when order is rearranged
    $(document).on('click', '.row-button.drag, .addEvent-button, .addInsert-button, .addItem-button', function() {
        setTimeout(initDraggable, 0);
    });
  </script>
</body>
</html>       