<!DOCTYPE html>
<html lang="en">
<head>
  <title>PaperworkPro</title>
  <style>
    td:nth-child(3) {
      vertical-align: top !important;
      padding-top: 8px !important;
    }
    
    /* For view mode */
    .view-mode td:nth-child(3) {
      vertical-align: top !important;
      padding-top: 8px !important;
      width: 400px !important;
    }
    
    /* Add these new styles */
    .view-mode td {
      vertical-align: top !important;
      padding-top: 8px !important;
    }
    
    .view-mode td > div {
      text-align: left;
      margin-top: 0;
      padding-top: 0;
    }

    /* Update cut line styling */
    .cut-line {
        position: relative;
        display: inline;
    }
    
    .cut-line::after {
        content: '';
        position: absolute;
        left: -350px; /* Extend line to the left */
        right: 0; /* Extend line to the right */
        bottom: -3px; /* Move line down by adjusting this value */
        height: 2px;
        background-color: black;
        z-index: 1;
        pointer-events: none;
    }

    /* shot type dropdown styling */
    .shot-type-select {
        background-color: transparent !important;
        border: none;
        outline: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        padding: 2px 2px 2px 2px;
        width: auto;
    }

    .shot-type-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        background-color: transparent !important;
        margin: 0;
        padding: 0;
    }

    /* Ensure proper positioning for cut line reference */
    td:nth-child(2), td:nth-child(3) {
        position: relative;
    }

    /* Update view mode specific styles */
    .view-mode td:nth-child(2) > div,
    .view-mode td:nth-child(2) .shot-type-flex-container,
    .view-mode td:nth-child(2) .editable-cell {
        position: relative;
        top: var(--original-top) !important;
    }

    /* Ensure proper positioning for cut line reference in view mode */
    .view-mode td:nth-child(2), 
    .view-mode td:nth-child(3) {
        position: relative;
    }

    /* shot type cell layout */
    .shot-type-flex-container {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .shotTypeDropdown {
        display: flex;
        align-items: center;
        gap: 2px;
        width: fit-content;
    }

    .shotSubject {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        margin-left: 4px;
    }

    .editable-cell {
        width: 100%;
        border: none;
        outline: none;
        background: transparent;
        margin-bottom: 2px;
        padding: 2px 8px;
    }

    /* Ensure proper spacing in view mode */
    .view-mode .shot-type-flex-container > div {
        margin-bottom: 2px;
    }

    /* Ensure proper vertical spacing */
    td:nth-child(2) > div {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>

<body> 
			<!-- Kinde Login/Register Form -->
	<div id="logged_out_view" class="auth-container">
		<div class="auth-card">
			<div class="app-icon">
				<i class="fas fa-film"></i>
			</div>
			<h1 class="app-title">PaperworkPro</h1>
			<p class="app-subtitle">Professional script management</p>
			
			<div class="auth-buttons">
				<button id="login" class="btn-primary">
					<i class="fas fa-user"></i>
					Sign In
				</button>
				<button id="register" class="btn-secondary">
					<i class="fas fa-user-plus"></i>
					Create Account
				</button>
			</div>
			
			<div class="security-note">
				<i class="fas fa-shield-alt"></i>
				<span>Secured with end-to-end encryption</span>
			</div>
		</div>
	</div>

	<!-- Authenticated User View -->
	<div id="logged_in_view" style="display:none;">
		<!-- Logout will be dynamically added here -->
	</div>

  <!-- Project Login Form -->
  <div id="project-login" class="project-container" style="display:none;">
    <div class="project-card">
      <div class="app-icon">
        <i class="fas fa-folder-open"></i>
      </div>
      <h1 class="app-title">Select Project</h1>
      <p class="app-subtitle">Choose your project to continue with EpisodicPro</p>
      
      <div class="project-form">
        <div class="input-group">
          <input type="text" id="projectName" name="projectName" class="project-input" placeholder="Enter project name" required>
        </div>
        <button id="projectLogBtn" class="btn-primary project-btn">
          <i class="fas fa-arrow-right"></i>
          Continue
        </button>
      </div>
      
      <div class="security-note">
        <i class="fas fa-shield-alt"></i>
        <span>Your projects are securely stored</span>
      </div>
    </div>
  </div>

  <!-- Main Page -->
  <div class="main-content">
    <nav class="nav-toolbar">
        <div class="toolbar-group left">
            <button class="btn button2 undo-button" title="Undo"><i class="fas fa-undo"></i></button>
            <button class="btn button2 redo-button" title="Redo"><i class="fas fa-redo"></i></button>
            <div class="divider"></div>
            <button class="btn button2 bold-button" title="Bold"><i class="fas fa-bold"></i></button>
            <button class="btn button2 italic-button" title="Italic"><i class="fas fa-italic"></i></button>
            <button class="btn button2 underline-button" title="Underline"><i class="fas fa-underline"></i></button>
            <button class="btn button2 highlight-button" title="Highlight"><i class="fas fa-highlighter"></i></button>
            <button class="btn button2 font-button" title="Font"><i class="fas fa-font"></i></button>
        </div>

        <div class="toolbar-group center">
            <button class="btn button2 addEvent-button" title="Add Event"><i class="fas fa-plus"></i> Event</button>
            <button class="btn button2 addInsert-button" title="Add Insert"><i class="fas fa-film"></i> Insert</button>
            <button class="btn button2 addItem-button" title="Add Item"><i class="fas fa-list"></i> Item</button> 
            <button class="btn button2 addDur-button" title="Add Duration"><i class="fas fa-clock"></i> Duration</button>
            <button class="btn button2 addCut-button" title="Add Cut"><i class="fas fa-cut"></i> Cut</button>
        </div>

        <div class="toolbar-group right">
            <!-- Dynamic buttons container - for buttons like Show Script, Running Order -->
            <div class="toolbar-group dynamic-buttons" id="dynamic-buttons-container">
                <button class="btn button2 primary" title="Save"><i class="fas fa-save"></i> Save</button> 
                <button class="btn button2 view-button" title="View"><i class="fas fa-eye"></i> View</button>
                <button class="btn button2 runningOrder-button" title="Running Order"> Running Order</button>
                <button class="btn button2 floorPlan-button" title="Floor Plan"> Floor Plan</button>

                <div class="dropdown">
                    <button class="btn button2 camCard-button" title="camCards"> CAMERA CARDS </button>
                    <div class="options" id="camera-options">
                        <!-- Dropdown options change when user adds more cameras to events -->
                    </div>
                </div>
            </div>
            
            <!-- Dedicated logout container - always rightmost -->
            <div class="toolbar-group logout-container" id="logout-container" style="display: none; margin-left: 16px;">
                <!-- Logout button will be dynamically added here -->
            </div>
        </div>
    </nav>

    <div class="production-title-container">
        <div style="margin-top:100px;" class="production-title" contenteditable="true"></div>
    </div>

    <div class="square"></div>

    <div class="container">
      <table style="margin-top:100px;" id="event-table" class="draggable-table">
          <thead>
              <tr>
                  <th scope="col" style="border: 1px solid black; width:100px; text-align: center;">Event number</th>
                  <th scope="col" style="border: 1px solid black; width:350px; text-align: center;">Shot</th>
                  <th scope="col" style="border: 1px solid black; width:450px; text-align: center;">Script</th>
                  <th scope="col" style="border: 1px solid black; width:150px; text-align: center;">Details</th>
                  <th scope="col" style="border: none; width:90px; text-align: center;"></th>
              </tr>
          </thead>
          <tbody>
          </tbody>
      </table>
    </div>
  </div>

  <!-- Question pop up -->
  <div class="modal fade" id="questionModal" tabindex="-1" role="dialog" aria-labelledby="questionModalLabel" aria-modal="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="questionModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modalOption1"></button>
          <button type="button" class="btn btn-primary" id="modalOption2"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- FLOOR PLAN POP UP -->
  <div id="fpCheckBox-form" title="Create Floor Plan">
    <form>
      <fieldset>
        <ul id="fpSubjects"></ul>
        <!-- Allow form submission with keyboard without duplicating the dialog button -->
        <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
      </fieldset>
    </form>
  </div>

  <!-- Subject Selection Modal -->
  <div id="subjectModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Floor Plan</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Select which subjects should appear in the floor plan:</p>
          <div id="subjectCheckboxes"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn button submitSubject-button" id="submitSubjects">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Kinde SDK -->
  <script src="node_modules/@kinde-oss/kinde-auth-pkce-js/dist/kinde-auth-pkce-js.umd.min.js"></script>
  
  <!-- Kinde Auth JavaScript -->
  <script src="scripts/kindeAuth.js"></script>

  <script type="text/javascript">
    // Kinde authentication integration - check for existing authentication state
    window.onload = function() {
        // Use setTimeout to ensure Kinde auth script has finished initializing
        setTimeout(() => {
            const isKindeLoggedIn = sessionStorage.getItem('isKindeLoggedIn');
            const projectName = sessionStorage.getItem('projectName');
            
            console.log('Window onload check:', { isKindeLoggedIn, projectName });
            
            // If user is authenticated with Kinde and has selected a project
            if (isKindeLoggedIn === 'true' && projectName) {
                console.log('User authenticated with project, showing main content');
                $('#logged_out_view').hide();
                $('#project-login').hide();
                $('.main-content').show();
                $('.production-title').text(projectName);
                document.title = projectName + ' - Studio Script Writer';
                
                // Show logout button if not already visible
                const logoutContainer = document.getElementById('logout-container');
                if (logoutContainer && window.kindeAuth) {
                    logoutContainer.style.display = 'flex';
                }
            } else if (isKindeLoggedIn === 'true') {
                // Authenticated but no project selected
                console.log('User authenticated without project, showing project selection');
                $('#logged_out_view').hide();
                $('#project-login').show();
            }
            // If not authenticated, the Kinde script will handle showing the login view
        }, 100); // Small delay to ensure Kinde script has finished
    };
    
    // Also listen for storage changes in case another tab modifies the session
    window.addEventListener('storage', function(e) {
        if (e.key === 'projectName' || e.key === 'isKindeLoggedIn') {
            location.reload();
        }
    });

    function preventDeletion(event, defaultContent) {
      const element = event.target;
      const row = element.closest('tr');
      
      
      //Use setTimeout to get the updated content after the current event cycle
      setTimeout(() => {
        const shotSubject = row.querySelector('.shotSubject');
        const cameraNum = row.querySelector('.cameraNum');
        const cameraPos = row.querySelector('.cameraPos');
        const extraInfo = row.querySelector('.extraInfo');

        //Check if any of the cells are empty
        if (shotSubject.textContent.length === 0) {
          //Restore the previous content
          shotSubject.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); //false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }

        if (cameraNum.textContent.length === 0) {
          //Restore the previous content
          cameraNum.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); //false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }

        if (cameraPos.textContent.length === 0) {
          //Restore the previous content
          cameraPos.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); //false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }

        if (extraInfo.textContent.length === 0) {
          //Restore the previous content
          extraInfo.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); //false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }
      }, 0);
    }
    

    var role;
    // $('#project-login').hide(); // Removed - now controlled by Kinde auth flow

    // Updated project login to work with Kinde authentication
    document.getElementById('projectLogBtn').addEventListener('click', function() {
      projectLogin();
    });

    function projectLogin() {
      var projectName = document.getElementById('projectName').value;
      
      // Check if user is authenticated with Kinde first
      const isKindeLoggedIn = sessionStorage.getItem('isKindeLoggedIn');
      if (isKindeLoggedIn !== 'true') {
        alert("Please log in first");
        return;
      }

      function projectCheck(json_file) {
        fetch(json_file, {method: 'GET'})
            .then(response => response.json())
            .then(result => {
              const projectList = result.productions.map(element => {
                  return element 
              })
              const targetProject = projectName.toLowerCase();
              
              let authenticated = false;
              
              // Get Kinde user information
              const kindeUser = JSON.parse(sessionStorage.getItem('kindeUser') || '{}');
              const userEmail = kindeUser.email || 'unknown';

              // For now, allow any authenticated Kinde user access to any project
              // You can modify this logic later to check specific user permissions
              for(let i = 0; i < projectList.length; i++) {
                if(targetProject === projectList[i]['name']) {
                    $('#project-login').hide();
                    $('.main-content').show();
                    $('.production-title').text(projectName);
                    document.title = projectName + ' - Studio Script Writer';
                    authenticated = true;
                    sessionStorage.setItem('projectName', projectName);
                    break;
                }
              }

              if(!authenticated) {
                alert("Production does not exist");
              } 
            })
            .catch(error => console.log("Error", error))
        }

        projectCheck("productions.json");
    }
    
    //Made this a global function so that initdraggable() can call it
    function updateEventNumbers() {
        let eventNumber = 1;
        $('#event-table tbody tr').each(function() {
            //Check if there is an event in the row (If Shot column or Insert has content)
            const hasEvent = $(this).find('td:nth-child(2)').text().trim().length > 0;
            const hasInsert = $(this).find('td:nth-child(3)').text().trim().length > 0;
            const isItem = $(this).hasClass('item_highlighted');
            
            if ((hasEvent || hasInsert) && !isItem) {  //Only number non-item rows
                $(this).find('td:first').text(eventNumber);
                eventNumber++;
            } 
        });
    }
    //UPDATE ITEM NUMBERS
    function updateItemNumbers() {
        let itemNumber = 1;
        $('#event-table tbody tr').each(function() {
            //Checks if there is an item 
            const isItem = $(this).hasClass('item_highlighted');
            
            if (isItem) { 
                //Update item number to account for dragging or deletion of rows
                const itemCell = $(this).find('td:nth-child(3)');
                const itemText = itemCell.find('b');
                itemText.text(`ITEM ${itemNumber}: \u00A0`);
                itemNumber++;
            } 
        });
    }

    //START
    $(document).ready(function() {
        
        var highlight = true;
        var cutLine = true;

        var tableData = [
            { eventNum: '1', shotType: '', content: 'Add your script here', details: 'E.g., Music Cues' },
        ];

        var dropdownOptions = ['SHOT TYPE', 'ES', 'WS', '2S', '3S', 'MS', 'MCU', 'CU', 'ECU', 'AS DIRECTED',  'CUSTOM'];
        

        //CREATE SHOT TYPE CELL
        function createShotTypeCell(shotType, firstTime) {
            var selectHTML = `
                <div class="shot-type-wrapper">
                    <select class="form-control shot-type-select">
                        ${dropdownOptions.map(option => `
                            <option value="${option}" ${(option === shotType) ? 'selected' : ''}>${option}</option>
                        `).join('')}
                    </select>
                    <input type="text" class="custom-shot-type" name="customShotType" autocomplete="off" style="display:none">
                    <input type="text" class="editable-text shotSubject" name="shotSubject" autocomplete="off" placeholder="Shot Subject">
                </div>`;

            return '<div>' +
                '<div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">' +
                    '<input type="text" class="editable-cell cameraNum event_highlighted" name="cameraNum" autocomplete="off" placeholder="Camera Number">' + 
                    '<input type="text" class="editable-cell cameraPos event_highlighted" name="cameraPos" autocomplete="off" placeholder="Camera Position">' + 
                '</div>' +
                '<div class="shot-type-flex-container event_highlighted">' +
                    selectHTML +
                '</div>' +
                '<input type="text" class="editable-cell extraInfo event_highlighted" name="extraInfo" autocomplete="off" placeholder="Additional Info (E.g., TRACK OUT)">' +
            '</div>';
        }

        //CREATE INSERT CELL
        function createInsertCell() {
          return '<div style="text-align: left; width: 60%; margin: 0 auto;" class="insert-content">' +
            '<u><input type="text" class="editable-cell insertTitle" name="insertTitle" autocomplete="off" style="text-align: left; width: 60%; margin: 0 auto; outline: none; color: rgb(16, 16, 16);" placeholder="Ven: Title"></u>' +
            '<input type="text" class="editable-text insertIn" name="insertIn" autocomplete="off" style="text-align: left; width: 60%; margin: 0 auto; outline: none; color: rgb(16, 16, 16);" placeholder="In: Music">' +
            '<div class="insert-duration-container" style="text-align: left; width: 60%; margin: 0 auto; margin-left: 18px; outline: none; color: rgb(16, 16, 16);">' +
                '<span style="white-space: nowrap; color: rgb(16, 16, 16);">Dur: ' +
                '<input type="time" id="durationVT" name="durationVT" autocomplete="off" value="00:00" style="border: none; width: auto; margin: 0 auto; color: rgb(16, 16, 16);">' +
                '</span>' +
            '</div>' +
            '<input type="text" class="editable-cell insertOut" name="insertOut" autocomplete="off" style="text-align: left; width: 60%; margin: 0 auto; outline: none; color: rgb(16, 16, 16);" placeholder="Out: Music">' +
          '</div>';
        }

        function createRowButtons() {
            const buttons = `<div class="row-actions">
                <button class="row-button drag" title="Drag Row">
                    <i class="fas fa-grip-vertical"></i>
                </button>
                <button class="row-button remove" title="Remove Row">
                    <i class="fas fa-minus"></i>
                </button>
            </div>`;
            return buttons;
        }

        //Update the table row creation code
        function createTableRow(type = 'default') {
            return `<tr class="${type}_highlighted">
                <td contenteditable="false" style="text-align:center"></td>
                <td contenteditable="true"></td>
                <td contenteditable="false"></td>
                <td contenteditable="true" style="text-align:center"></td>
                <td style="border:none; width:90px">${createRowButtons()}</td>
            </tr>`;
        }

        //Make the first item's input expandable
        $('.item-content').first().css({
            'height': 'auto',
            'min-height': '24px'
        }).on('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        $(document).on('click', '.row-button.remove', function() {
            if ($('#event-table tbody tr').length > 1) {
                $(this).closest('tr').remove();
                updateEventNumbers(); //Reorder event numbers
                updateItemNumbers(); //Reorder item numbers for the running order
                initDraggable(); //Reinitialize draggable after removing a row
            }
        });

        //ADD EVENT 
        $('.addEvent-button').on('click', function() {
            var selection = window.getSelection();
            var targetRow;

            //Find if the user has text selected
            if (selection.rangeCount > 0) {
                var range = selection.getRangeAt(0);
                //First try to find the closest td, then find its parent tr
                var cell = range.commonAncestorContainer.nodeType === 1 
                    ? range.commonAncestorContainer.closest('td')?.closest('tr')
                    : range.commonAncestorContainer.parentElement.closest('td')?.closest('tr');
                if (cell) {
                    targetRow = $(cell);
                    var newRow = $('<tr class="event_highlighted">' +
                        '<td contenteditable="false" style="text-align:center"></td>' +
                        '<td contenteditable="true">' + createShotTypeCell("SHOT TYPE", false) + '</td>' +
                        '<td contenteditable="true"></td>' +
                        '<td contenteditable="true" style="text-align:center"></td>' +
                        '<td style="border:none; width:90px">' + createRowButtons() + '</td>' +
                    '</tr>');
                    
                    $(newRow).insertAfter(targetRow);
                    updateEventNumbers();
                    initDraggable(); //Make it draggable
                    return;
                }
            }

            //If no selection, create new row at the end
            var newRow = '<tr class="event_highlighted">' +
                '<td contenteditable="false" style="text-align:center"></td>' +
                '<td contenteditable="true">' + createShotTypeCell("SHOT TYPE", false) + '</td>' +
                '<td contenteditable="true"></td>' +
                '<td contenteditable="true" style="text-align:center"></td>' +
                '<td style="border:none; width:90px">' + createRowButtons() + '</td>' +
            '</tr>';
            $('#event-table tbody').append(newRow);
            updateEventNumbers();
            
            //Initialize draggable on the newly added row
            initDraggable();
        });

        //UNDERLINE
        $('.underline-button').on('click', function() {
          document.execCommand('underline', false, null);
        });

        //BOLD
        $('.bold-button').on('click', function() {
          document.execCommand('bold', false, null);
        });

        //ITALIC
        $('.italic-button').on('click', function() {
          document.execCommand('italic', false, null);
        });

        //FONT
        $('.font-button').on('click', function() {
            const body = document.body;
            const currentFont = window.getComputedStyle(body).fontFamily;
            
            //Toggle between Arial and Opendyselxic
            if (currentFont.includes('OpenDyslexic')) {
                body.style.setProperty('font-family', 'Arial, sans-serif', 'important');
                localStorage.setItem('preferredFont', 'Arial');
            } else {
                body.style.setProperty('font-family', 'OpenDyslexic, Arial, sans-serif', 'important');
                localStorage.setItem('preferredFont', 'OpenDyslexic');
            }
        });

        //ADD CUT ON CLICK
        $('.addCut-button').on('click', function() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const cell = range.commonAncestorContainer.nodeType === 1 
                ? range.commonAncestorContainer.closest('td')
                : range.commonAncestorContainer.parentElement.closest('td');
                
            if (!cell || cell.cellIndex !== 2) return;

            const selectedText = selection.toString();
            const existingCutLine = cell.querySelector('.cut-line');

            function createCutLine(text) {
                const span = document.createElement('span');
                span.className = 'cut-line';
                span.textContent = text;
                return span;
            }

            function addSlashAfter(element) {
                const textNode = document.createTextNode(" / ");
                element.after(textNode);
                return textNode;
            }

            function moveCursorAfter(node) {
                const newRange = document.createRange();
                newRange.setStartAfter(node);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }

            if (existingCutLine) {
                showQuestionModal(
                    "Remove or Add new event?", //question
                    "Remove", //option 1
                    "Add new event", //option 2

                    //REMOVE
                    function() {
                      var selection = window.getSelection();
                      var range = selection.getRangeAt(0);
                      var newText = selection.toString();
                      //Removes the '/' cut within the highlight
                      newText = newText.replace(/ \/ /g, ' ').trim();           

                      //Get the cell containing the selection
                      const cell = range.commonAncestorContainer.nodeType === 1 
                          ? range.commonAncestorContainer.closest('td')
                          : range.commonAncestorContainer.parentElement.closest('td');
                      
                      //Find and remove the existing cut line
                      const existingCutLine = cell.querySelector('.cut-line');
                      if (existingCutLine) {
                        //Remove the cut line and the following slash
                        const nextNode = existingCutLine.nextSibling;
                        if (nextNode && nextNode.nodeType === Node.TEXT_NODE && nextNode.textContent.includes('/')) {
                          nextNode.remove();
                        }
                        existingCutLine.remove();
                      }
                    },
                    //ADD TO NEW EVENT
                    function() {
                        const selectedText = selection.toString();

                        $('.addEvent-button').trigger('click');
                        updateEventNumbers();

                        const newRow = cell.closest('tr').nextElementSibling;
                        const newScriptCell = newRow.cells[2];

                        const cutLineSpan = createCutLine(selectedText);
                        newScriptCell.appendChild(cutLineSpan);
                        addSlashAfter(cutLineSpan);

                        range.deleteContents();
                        if (cell.textContent.trim() === '') {
                            cell.textContent = '';
                        }
                    }
                );
            } else {
                try {
                    const newSpan = createCutLine(selectedText);
                    range.deleteContents();
                    range.insertNode(newSpan);
                    const textNode = addSlashAfter(newSpan);
                    moveCursorAfter(textNode);
                } catch (e) {
                    console.log("Could not add cut line: Selection may be invalid");
                }
            }
        });

        //ADD DURATION
        $('.addDur-button').on('click', function() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const timeInput = $('<input type="time" style="border: none; width: auto;">');
            range.deleteContents();
            range.insertNode(timeInput[0]);
            timeInput.focus();
        });

        //UNDO
        $('.undo-button').on('click', function() {
          document.execCommand('undo', false, null);
        });

        //REDO
        $('.redo-button').on('click', function() {
          document.execCommand('redo', false, null);
        });

        //HIGHLIGHT
        $('.highlight-button').on('click', function() {
          $(this).toggleClass('active');
          if ($(this).hasClass('active')) {
            document.execCommand('backColor', false, 'yellow');
          } else {
            document.execCommand('backColor', false, 'transparent');
          }
        });

        //VIEW MODE
        $('.view-button').on('click', function() {
            const tableClone = $('.container').clone();
            const productionTitle = $('.production-title').text();
            
            // Store the original top positions as CSS variables
            tableClone.find('tr.event_highlighted').each(function() {
                const row = $(this);
                const shotCell = row.find('td:nth-child(2)');
                const scriptCell = row.find('td:nth-child(3)');
                
                // Store the original top positions as CSS variables
                shotCell.find('.editable-cell, .shot-type-flex-container').each(function() {
                    const topValue = $(this).css('top');
                    if (topValue && topValue !== 'auto') {
                        $(this).css('--original-top', topValue);
                    }
                });
            });

            //Handle shot type cells specifically
            tableClone.find('tr.event_highlighted').each(function() {
                const row = $(this);
                const shotCell = row.find('td:nth-child(2)');
                const scriptCell = row.find('td:nth-child(3)');
                const cameraNum = shotCell.find('.cameraNum').val() || '';
                const cameraPos = shotCell.find('.cameraPos').val() || '';
                const shotTypeSelect = shotCell.find('.shot-type-select');
                const customInput = shotCell.find('.custom-shot-type');
                
                // Get the selected shot type value correctly
                if(customInput.val() !== '') {
                    const shotType = customInput.val();
                } else {
                    const originalSelects = $('.container .shot-type-select');
                    tableClone.find('.shot-type-select').each(function(index) {
                        const originalSelect = originalSelects.eq(index);
                        const selectedText = originalSelect.find('option:selected').text();
                        shotType = selectedText;
                        if(shotType === 'SHOT TYPE') {
                            shotType = '';
                        }
                    });
                }
                
                const shotSubject = shotCell.find('.shotSubject').val() || '';
                const extraInfo = shotCell.find('.extraInfo').val() || '';

                // Get the original top position from the style attribute
                const originalTop = shotCell.find('.shot-type-flex-container').css('top') || '0px';

                // Structure the content in three distinct lines
                const newContent = `
                    <div style="position: relative; top: ${originalTop}; display: flex; flex-direction: column; gap: 4px;">
                        <div style="margin-bottom: 4px;">${cameraNum}${cameraPos}</div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span style="white-space: nowrap;">${shotType}</span>
                            <span style="margin-left: 8px;">${shotSubject}</span>
                        </div>
                        <div>${extraInfo}</div>
                    </div>
                `;

                // Replace the shot cell with the user inputs while preserving positioning
                shotCell.html(newContent);

                // Preserve the script cell content including cut lines
                const scriptContent = scriptCell.html();
                if (scriptContent) {
                    scriptCell.html(scriptContent);
                }
            });

            //Preserve cut line positioning and styling
            tableClone.find('.cut-line').each(function() {
                $(this).css({
                    'position': 'relative',
                    'display': 'inline',
                    'white-space': 'pre-wrap'
                });
            });

            //Add cut line styles to the view window
            const cutLineStyles = `
                .cut-line {
                    position: relative;
                    display: inline;
                    white-space: pre-wrap;
                }
                .cut-line::after {
                    content: '';
                    position: absolute;
                    left: -350px;
                    right: 0;
                    bottom: -3px;
                    height: 2px;
                    background-color: black;
                    z-index: 1;
                    pointer-events: none;
                }
            `;

            //Remove editable custom cell from shot column
            tableClone.find('td:nth-child(2) .custom-shot-type').each(function() {
                const content = $(this).text().trim();
                $(this).replaceWith($('<span>').text(' '));
            });
            
            //Make all contenteditable elements non-editable in view mode
            tableClone.find('[contenteditable="true"]').attr('contenteditable', 'false');

            function setDuration() {
                //Make all duration elements uneditable strings
                tableClone.find('input[type="time"]').each(function() {
                const timeValue = $(this).val() || '00:00';
                const [minutes, seconds] = timeValue.split(':');
                $(this).replaceWith($('<span>').text(`${minutes}'${seconds}"`));
            });
            }
            
            // Call setDuration function
            setDuration();

            //Replace 'New Item' with what the user has inputted
            tableClone.find('td:nth-child(3) .item-content').each(function() {
                const userInput = $(this).val() || $(this).text() || 'New Item';
                const span = $('<span style="text-decoration: underline; margin-left: -8px; display: inline-block;">').text(userInput);
                $(this).replaceWith(span);
            });

            //Replace Inserts with what the user has inputted
            tableClone.find('td:nth-child(3) .insert-content').each(function() {
                const insertTitle = $(this).find('.insertTitle').val() || 'Ven: Title';
                const insertIn = $(this).find('.insertIn').val() || 'In: Music';
                const insertOut = $(this).find('.insertOut').val() || 'Out: Music';
                const timeValue = ($(this).find('input[type="time"]')).val();
                const [minutes, seconds] = timeValue.split(':');

                // Create a formatted insert display
                const formattedInsert = `
                    <div class="insert-content">
                        <div style="text-align: left; width: 60%; margin: 0 auto;">
                            <u>${insertTitle}</u>
                            <div>${insertIn}</div>
                            <div>Dur: ${`${minutes}'${seconds}"`}</div>
                            <div>${insertOut}</div>
                        </div>
                    </div>
                `;
                
                $(this).replaceWith(formattedInsert);
            });
            
            //Create new window/tab and write content
            const viewWindow = window.open('', '_blank');
            viewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>View Mode</title>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
                    <style>
                        ${cutLineStyles}
                        body { 
                            padding-top: 20px;
                            color: rgb(16, 16, 16) !important;
                        }
                        table {
                            width: 794px !important;
                            table-layout: fixed;
                            margin: 0 auto;
                            border-collapse: separate !important;
                            border-spacing: 0 10px;
                        }
                        td, th{
                            border: none !important;
                            outline: none !important;
                        }
                        .editable-cell,
                        .editable-text,
                        div[contenteditable] {
                            outline: none !important;
                            border: none !important;
                            min-height: 24px;
                            vertical-align: top !important;
                            height: auto;
                            min-height: 24px;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            overflow: visible;
                            resize: vertical;
                            padding: 4px 8px;
                            width: 100%;
                            box-sizing: border-box;
                        }
                        .shot-type-select {
                            width: fit-content;
                            text-align: left;
                            border: none;
                            outline: none;
                            background-color: none !important;
                        }
                        .btn {
                            display: none;
                        }
                        .cut-line {
                            position: relative;
                        }
                        .cut-line::after {
                            content: '';
                            position: absolute;
                            left: -350px;
                            right: 0;
                            bottom: -3px;
                            height: 2px;
                            background-color: black;
                            z-index: 1;
                            pointer-events: none;
                        }
                        .shot-type-flex-container {
                            display: flex;
                            align-items: center;
                            gap: 2px; 
                        }
                        .shot-type-flex-container2 {
                            display: flex;
                            align-items: center;
                            gap: 0.5px; 
                        }
                        .shot-type-text {
                            flex-grow: 1;
                            margin-left: 8px;
                        }
                        .shotTypeDropdown {
                            flex-shrink: 0;
                            margin-right: 4px;
                        }
                        .insert-duration-container {
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            text-align: center;
                            margin: 0 auto;
                        }
                        .insert-duration-container > * {
                            display: inline-block;
                            vertical-align: middle;
                            margin: 0;
                        }
                        .insert-duration-container > * {
                            display: inline-block;
                            vertical-align: middle;
                            margin: 0;
                        }
                        .insertDuration {
                            padding-right: 4px !important;
                            text-align: right !important;
                        }
                        .production-title {
                            text-align: left;
                            font-size: 24px;
                            font-weight: bold;
                            padding: 8px 16px;
                            margin-top: 100px;
                            margin-bottom: -75px;
                            margin-left: 250px;
                            outline: none !important;
                            border: none !important;
                        }
                        .insert-content {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                            color: rgb(16, 16, 16) !important;
                        }
                        .insert-content > * {
                            margin: 0;
                            width: 100%;
                            text-align: center;
                            color: rgb(16, 16, 16) !important;
                        }
                        .insert-content span {
                            color: rgb(16, 16, 16) !important;
                        }
                        td {
                            color: rgb(16, 16, 16) !important;
                        }
                        .shot-type-wrapper {
                            margin-top: 0;
                            padding-top: 0;
                        }
                        td:nth-child(2) {
                            vertical-align: top !important;
                            padding-top: 8px !important;
                        }
                        td:first-child {
                            vertical-align: top !important;
                            padding-top: 8px !important;
                        }
                        td event_highlighted {
                            position: absolute;
                        }
                        
                        /* Add these styles */
                        td {
                            vertical-align: top !important;
                            padding-top: 8px !important;
                        }
                        
                        td > div {
                            text-align: left;
                            margin-top: 0;
                            padding-top: 0;
                        }
                        
                        .script-cell {
                            text-align: left;
                            vertical-align: top !important;
                            padding-top: 8px !important;
                        }
                    </style>
                </head>
                <body class="view-mode">
                    <div class="production-title">${productionTitle}</div>
                    ${tableClone.html()}
                </body>
                </html>
            `);
            
            // Add this after the document.write to ensure styles are applied
            viewWindow.document.close();
            viewWindow.addEventListener('load', function() {
                // Force a repaint of cut lines
                const cutLines = viewWindow.document.querySelectorAll('.cut-line');
                cutLines.forEach(line => {
                    line.style.display = 'inline';
                    line.style.position = 'relative';
                    // Force a repaint
                    line.offsetHeight;
                });
            });
            
            //Remove the last column (the add/remove buttons)
            viewWindow.document.querySelectorAll('tr').forEach(row => {
                const lastCell = row.lastElementChild;
                if (lastCell) {
                    lastCell.remove();
                }
            });

            //Remove the text in the header
            viewWindow.document.querySelectorAll('th').forEach(header => {
                header.textContent = '';
            });
            
            viewWindow.document.close();
        });

        //dropdown menu closes when user clicks elsewhere
        function show(value) {
            document.querySelector(".text-box").value = value;
        }
        
        let dropdown = document.querySelector(".dropdown")
        dropdown.onclick = function() {
            dropdown.classList.toggle("active")
        }

        //CAMERA CARD DROPDOWN
        $('.camCard-button').on('click', function() {
            let camList = []; //stores list of unique cameras
            let camCards = []; //Stores all info for events

            $('#event-table').find('tr.event_highlighted').each(function() {
                const row = $(this);
                
                const eventNum = row.find('td:first-child').text() || '';
                const shotCell = row.find('td:nth-child(2)');

                const cameraNum = shotCell.find('.cameraNum').val() || '';
                const cameraPos = shotCell.find('.cameraPos').val() || '';
                const shotType = shotCell.find('.shot-type-select').val() || '';
                const shotSubject = shotCell.find('.shotSubject').val() || '';
                const info = shotCell.find('.extraInfo').val() || '';

                //Adds events to the camera array as objects
                let event = {
                    eventNumber: eventNum,
                    cameraNumber: cameraNum,
                    cameraPosition: cameraPos,
                    shotType: shotType,
                    shotSubject: shotSubject,
                    extraInfo: info
                };  
                camCards.push(event);
            });
            
            //Get a list of cameras, ignoring duplicate mentions
            for(let i = 0; i < camCards.length; i++) {
                let alreadyAdded = false;
                let tempCamNum = camCards[i].cameraNumber; //Store current cam number

                if(tempCamNum && !(camList.includes(tempCamNum))) {
                    camList.push(tempCamNum);
                }
            }
            
            //Populates the dropdown menu with the available camera options
            const dropdown = $('#camera-options');
            dropdown.empty(); //Clear existing options
            
            if (camList.length === 0) {
                dropdown.append('<div>No cameras found</div>');
            } else {
                camList.forEach((camera) => {
                    const cameraOption = $(`<div><button class="btn button3 createCamCard-button" id="${camera}" title="camOption"> CAMERA ${camera}</button></div>`);
                    dropdown.append(cameraOption);
                });
            }
        
        });

    
        //CREATE CAMERA CARD
        $(document).on('click', '.createCamCard-button', function() {
            let cameraNumber = (this.id);
            let camCards = [];

            $('#event-table').find('tr.event_highlighted').each(function() {
                const row = $(this);
                
                const eventNum = row.find('td:first-child').text() || '';
                const shotCell = row.find('td:nth-child(2)');
                

                const cameraNum = shotCell.find('.cameraNum').val() || '';
                const cameraPos = shotCell.find('.cameraPos').val() || '';
                let shotType = shotCell.find('.shot-type-select').val() || '';
                const shotSubject = shotCell.find('.shotSubject').val() || '';
                const info = shotCell.find('.extraInfo').val() || '';

                if(shotType === "SHOT TYPE") {
                    shotType = '';
                }
                //Adds events to the camera array as objects
                let event = {
                    eventNumber: eventNum,
                    cameraNumber: cameraNum,
                    cameraPosition: cameraPos,
                    shotType: shotType,
                    shotSubject: shotSubject,
                    extraInfo: info
                };  
                camCards.push(event);
            });

            

            //Filter events for the selected camera
            const currentCameraEvents = camCards.filter(event => event.cameraNumber === cameraNumber);

            //Create new window and display camera card for the selected camera
            const camCardWindow = window.open('', '_blank');
            camCardWindow.document.write(`
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Camera Card: Camera ${cameraNumber}</title>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
                        <style>
                            body { padding: 20px; }
                            table { width: 794px; margin: 0 auto; }
                            th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
                            th { background-color: #f2f2f2; }
                        </style>
                    </head>
                    <body>
                        <h2 style="margin-left: 420px;">Camera ${cameraNumber}</h2>
                        <div class="container">
                            <table id="camCard-table" style="align: center;">
                                <thead>
                                    <tr>
                                        <th scope="col" style="width:15%; text-align: center;">Shot</th>
                                        <th scope="col" style="width:15%; text-align: center;">Position</th>
                                        <th scope="col" style="width:50%; text-align: center;">Description</th>
                                        <th scope="col" style="width:20%; text-align: center;">Notes</th>   
                                    </tr>
                                </thead>
                                <tbody>
                                    ${currentCameraEvents.map(event => `
                                        <tr>
                                            <td style="text-align: center;">${event.eventNumber}</td>
                                            <td style="text-align: center;">${event.cameraPosition}</td>
                                            <td style="text-align: left;">${event.shotType} ${event.shotSubject}</td>
                                            <td contenteditable="true">${event.extraInfo}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </body>
                </html>
            `);
            camCardWindow.document.close();
        });

        //FLOORPLAN
        $('.floorPlan-button').on('click', function () {
            var productionTitle = $('.production-title').text();
            let cameraNumber = (this.id);
            let eventInfo = [];
            let camList = [];
            let subjectList = [];
            let subjectInitials = [];

            $('#event-table').find('tr.event_highlighted').each(function() {
                const row = $(this);
                const shotCell = row.find('td:nth-child(2)');
        
                const cameraNum = shotCell.find('.cameraNum').val() || '';
                const shotSubject = shotCell.find('.shotSubject').val() || '';
            
                //Adds events to the camera array as objects
                let event = {
                    cameraNumber: cameraNum,
                    shotSubject: shotSubject,
                };  
                eventInfo.push(event);
            });

            for(let i = 0; i < eventInfo.length; i++) {
                let alreadyAdded = false;
                let tempCamNum = eventInfo[i].cameraNumber; //Store current cam number
                let tempSubject = eventInfo[i].shotSubject;

                if(tempCamNum && !(camList.includes(tempCamNum))) {
                    camList.push(tempCamNum);
                }
                if(tempSubject && !(subjectList.includes(tempSubject))) {
                    subjectList.push(tempSubject);
                }
            }

            //If no subjects found, open floor plan directly
            if (subjectList.length === 0) {
                openFloorPlan(productionTitle, camList, []);
                return;
            }

            //UNIQUE INITIAL FEATURE 
            // //Generate unique initials for subjects
            // subjectInitials = generateUniqueInitials(subjectList);
            // console.log('Subject initials:', subjectInitials);

            // //Function to generate unique initials
            // function generateUniqueInitials(subjects) {
            //     if (subjects.length === 0) return [];
            //     if (subjects.length === 1) return [subjects[0].charAt(0)];

            //     const initials = [];
                
            //     for (let i = 0; i < subjects.length; i++) {
            //         const currentSubject = subjects[i];
            //         let minLength = 1;
                    
            //         //Check against all other subjects to find minimum unique length
            //         for (let j = 0; j < subjects.length; j++) {
            //             if (i === j) continue; // Skip comparing with itself
                        
            //             const otherSubject = subjects[j];
            //             const maxLength = Math.min(currentSubject.length, otherSubject.length);
                        
            //             //Find where the two subjects differ
            //             for (let k = 0; k <= maxLength; k++) {
            //                 if (k === maxLength || currentSubject.charAt(k) !== otherSubject.charAt(k)) {
            //                     minLength = Math.max(minLength, k + 1);
            //                     break;
            //                 }
            //             }
            //         }
            //         //Add the unique initial (minimum length needed)
            //         //If more than 2 letters are needed, display the full subject name
            //         if (minLength > 2) {
            //             initials.push(currentSubject);
            //         } else {
            //             initials.push(currentSubject.substring(0, minLength));
            //         }
            //     }
                
            //     return initials;
            // }

            // Populate the modal with checkboxes
            const subjectCheckboxes = document.getElementById('subjectCheckboxes');
            const checkboxHTML = subjectList.map(subject => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="subject_${subject}" value="${subject}" checked>
                    <label class="form-check-label" for="subject_${subject}">
                        ${subject}
                    </label>
                </div>
            `).join('');
            subjectCheckboxes.innerHTML = checkboxHTML;

            // Show the modal
            const subjectModal = new bootstrap.Modal(document.getElementById('subjectModal'));
            subjectModal.show();

            //Handle submit button click
            $('#submitSubjects').on('click', function() {
                const selectedSubjects = [];
                subjectList.forEach(subject => {
                    const checkbox = document.getElementById(`subject_${subject}`);
                    if (checkbox && checkbox.checked) {
                        selectedSubjects.push(subject);
                    }
                });
                
                // Close modal and open floor plan
                subjectModal.hide();
                openFloorPlan(productionTitle, camList, selectedSubjects, subjectInitials);
            });
        });

        // Function to open the floor plan window
        function openFloorPlan(productionTitle, camList, selectedSubjects, subjectInitials) {
            const floorPlanWindow = window.open('', '_blank');
            floorPlanWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>  
                    <title>${productionTitle} Floor Plan</title>
                    
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
                        integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
                        crossorigin="anonymous" referrerpolicy="no-referrer"/>

                    <style>
                        body {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            min-height: 100vh;
                            background-color: #e3dede;
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                            font-family: Arial;
                        }

                        .container {
                            display: flex;
                            gap: 10px;
                            height: 540px;
                            max-width: 1050px;
                            width: 100%;
                            border-radius: 20px;
                        }

                        .tools-board {
                            width: 210px;
                            height: 590px;
                            border-radius: 20px;
                            background-color: #f8f7f6;
                            padding: 15px 22px 0;
                        }

                        .tools-board .row {
                            margin-bottom: 20px;
                        }

                        .row .options {
                            list-style: none;
                            margin: 10px 0 0 5px;
                        }

                        .row .options .option {
                            display: flex;
                            cursor: pointer;
                            align-items: center;
                            margin-bottom: 10px;
                        }

                        .option:is(:hover, .active) img {
                            filter: grayscale(20%);
                        }

                        .option :where(span, label) {
                            color: black;
                            cursor: pointer;
                            padding-left: 10px;
                        }

                        .option:is(:hover, .active) :where(span, label) {
                            color: #f4130b;
                        }

                        .option.active {
                            background-color: #e0e0e0;
                            border-radius: 5px;
                        }

                        .option #fill-color {
                            height: 14px;
                            cursor: pointer;
                            width: 14px;
                        }

                        #fill-color:checked~label {
                            color: #e93e2b;
                        }

                        .option #size-slider {
                            width: 100%;
                            height: 5px;
                            margin-top: 10px;
                        }

                        .colors .options {
                            display: flex;
                            justify-content: space-between;
                        }

                        .colors .option {
                            height: 20px;
                            width: 20px;
                            margin-top: 3px;
                            position: relative;
                        }

                        .option #color-picker {
                            opacity: 1;
                            cursor: pointer;
                            width: 30px;
                            height: 30px;
                            border: none !important;
                            outline: none !important;
                            padding: 0;
                            margin: 0;
                            overflow: hidden;
                            -webkit-appearance: none;
                            -moz-appearance: none;
                            appearance: none;
                        }

                        .buttons button {
                            width: 80%;
                            color: #fff;
                            border: none;
                            outline: none;
                            font-size: 0.9rem;
                            padding: 3px 0;
                            margin-bottom: 13px;
                            background: none;
                            border-radius: 5px;
                            cursor: pointer;
                        }

                        .buttons .clear-canvas {
                            color: black;
                            border: 1px solid #9fc39f;
                            transition: all 0.2s ease;
                            border: 2px solid black;
                            font-size: 13px;
                        }

                        .clear-canvas:hover {
                            color: #fff;
                            background: #6c757d;
                        }

                        .buttons .save-img,
                        .addSub {
                            background: white;
                            color: black;
                            border: 1px solid #6c757d;
                        }

                        .mode-buttons {
                            margin-top: 10px;
                        }

                        .mode-btn {
                            width: 80%;
                            color: #fff;
                            border: none;
                            outline: none;
                            font-size: 0.9rem;
                            padding: 8px 0;
                            margin-bottom: 8px;
                            background: #6c757d;
                            border-radius: 5px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        }

                        .mode-btn.active {
                            background: #28a745;
                            color: white;
                        }

                        .mode-btn:hover {
                            opacity: 0.8;
                        }

                        .drawing-board {
                            flex: 1;
                        }

                        .drawing-board canvas {
                            width: 100%;
                            height: 590px;
                            border-radius: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <section class="tool-board">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="title"><strong>Tools</strong></label>
                                    <ul class="options">
                                        <li class="option tool" id="pencil">
                                            <i class="fas fa-pencil" id="icon"></i>
                                            <span>Pencil</span>
                                        </li>
                                        <li class="option tool" id="eraser">
                                            <i class="fas fa-eraser" id="icon"></i>
                                            <span>Eraser</span>
                                        </li>
                                        <li class="option tool" id="text">
                                            <i class="fas fa-font" id="icon"></i>
                                            <span>Text</span>
                                        </li>
                                        <li class="option">
                                            <input type="range" id="size-slider" min="1" max="30" value="5">
                                        </li>
                                    </ul>
                                </div>
                                <div class="row colours">
                                    <label for="" class="title">Colours</label>
                                    <ul class="options">
                                        <li class="option">
                                            <input type="color" value="#000000" name="" id="color-picker" style="background-color: #000000; border: none;">
                                        </li>
                                    </ul>
                                </div>

                                <div class="row">
                                    <label for="" class="title"><strong>Shapes</strong></label>
                                    <ul class="options">
                                        <li class="option tool" id="rectangle">
                                            <i class="fa-solid fa-dice-one"></i>
                                            <span>Rectangle</span>
                                        </li>
                                        <li class="option tool" id="circle">
                                            <i class="fa-solid fa-circle"></i>
                                            <span>Circle</span>
                                        </li>
                                        <li class="option tool" id="triangle">
                                            <i class="fa-solid fa-mountain"></i>
                                            <span>Triangle</span>
                                        </li>
                                        <li class="option tool" id="line">
                                            <i class="fa-solid fa-grip-lines"></i>
                                            <span>Line</span>
                                        </li>
                                        <li class="option tool" id="arrow">
                                            <i class="fa-solid fa-arrow-up"></i>
                                            <span>Arrow</span>
                                        </li>
                                        <li class="option tool" id="square">
                                            <i class="far fa-square"></i>
                                            <span>Square</span>
                                        </li>
                                        <li class="option tool" id="hexagon">
                                            <i class="fa-solid fa-cube"></i>
                                            <span>Hexagon</span>
                                        </li>
                                        <li class="option tool" id="pentagon">
                                            <i class="fa-solid fa-dice-d6"></i>
                                            <span>Pentagon</span>
                                        </li>
                                        <li class="option">
                                            <input type="checkbox" id="fill-color">
                                            <label for="fill-color">Fill Color</label>
                                        </li>
                                    </ul>
                                </div>
                                <div class="row buttons">
                                    <button class="clear-canvas">Clear Canvas</button>
                                    <button class="save-img">Save Image</button>
                                </div>
                                <div class="row mode-buttons">
                                    <button class="mode-btn draw-mode active" id="draw-mode">Draw Mode</button>
                                    <button class="mode-btn select-mode" id="select-mode">Select Mode</button>
                                </div>
                            </section>
                            <section class="drawing-board">
                                <canvas id="canvas" width="600" height="590" style="border:1px solid #000000;"></canvas>
                            </section>
                            <section class="tool-board">
                                <div class="row">
                                    <label class="title"><strong>Script Items</strong></label>
                                    <ul id="scriptItems"></ul>
                                    <input type="text" id="newSub" name="newSubject" autocomplete="off" onfocus="this.value=''" placeholder="Enter new subject">
                                    <button class="addSub">Add Subject</button>
                                </div>
                            </section>
                    </div>
                </body>
                </html>
            `);
            floorPlanWindow.document.close();
            
            // Initialize everything in one function
            function initializeFloorPlan() {
                console.log('Starting floor plan initialization...');
                
                // Load FontAwesome script
                const fontAwesomeScript = floorPlanWindow.document.createElement('script');
                fontAwesomeScript.src = 'https://kit.fontawesome.com/c353d71a36.js';
                fontAwesomeScript.crossOrigin = 'anonymous';
                floorPlanWindow.document.head.appendChild(fontAwesomeScript);
                
                // Load Fabric.js script
                const fabricScript = floorPlanWindow.document.createElement('script');
                fabricScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js';
                
                fabricScript.onload = function() {
                    console.log('Fabric.js loaded successfully');
                    
                    // Check if Fabric.js is available
                    if (typeof floorPlanWindow.fabric === 'undefined') {
                        console.error('Fabric.js not loaded properly');
                        alert('Fabric.js failed to load. Please refresh the page.');
                        return;
                    }
                    
                    // Check if canvas element exists
                    const canvasElement = floorPlanWindow.document.getElementById('canvas');
                    if (!canvasElement) {
                        console.error('Canvas element not found in DOM');
                        alert('Canvas element not found. Please refresh the page.');
                        return;
                    }
                    
                    try {
                        // Initialize Fabric.js canvas
                        canvas = new floorPlanWindow.fabric.Canvas('canvas', {
                            backgroundColor: '#ffffff',
                            width: 600,
                            height: 590,
                            isDrawingMode: false
                        });
                        
                        console.log('Fabric.js canvas initialized successfully');
                        
                        // Store canvas reference
                        floorPlanWindow.canvas = canvas;
                        
                                        // Set up all event handlers and UI
                setupFloorPlanUI(canvas);
                
                // Configure canvas selection behavior - start in draw mode
                canvas.selection = false;
                canvas.forEachObject(function(obj) {
                    obj.selectable = false;
                });
                
                // Disable canvas default behaviors for drawing
                canvas.defaultCursor = 'crosshair';
                canvas.hoverCursor = 'crosshair';
                        
                    } catch (error) {
                        console.error('Error initializing Fabric.js canvas:', error);
                        alert('Error initializing canvas. Please refresh the page.');
                        return;
                    }
                };
                
                fabricScript.onerror = function() {
                    console.error('Failed to load Fabric.js');
                    alert('Fabric.js failed to load. Please refresh the page.');
                };
                
                floorPlanWindow.document.head.appendChild(fabricScript);
            }
            
            function setupFloorPlanUI(canvasInstance) {
                console.log('Setting up floor plan UI...');
                
                if (!canvasInstance) {
                    console.error('Canvas is not available for UI setup');
                    return;
                }
                
                const toolBtns = floorPlanWindow.document.querySelectorAll(".tool");
                const fillColor = floorPlanWindow.document.querySelector("#fill-color");
                const sizeSlider = floorPlanWindow.document.querySelector("#size-slider");
                const colorBtns = floorPlanWindow.document.querySelectorAll(".colors .option");
                const colorPicker = floorPlanWindow.document.querySelector("#color-picker");
                const clearCanvas = floorPlanWindow.document.querySelector(".clear-canvas");
                const saveImage = floorPlanWindow.document.querySelector(".save-img");
                const addSubject = floorPlanWindow.document.querySelector(".addSub");
                const scriptItems = floorPlanWindow.document.getElementById('scriptItems');
                const drawModeBtn = floorPlanWindow.document.querySelector("#draw-mode");
                const selectModeBtn = floorPlanWindow.document.querySelector("#select-mode");

                // Global variables
                let selectedTool = "pencil";
                let brushWidth = 5;
                let selectedColor = "#000";
                let isDrawing = false;
                let path = null;
                let lastPoint = null;
                let drawMode = true; // Start in draw mode
                let currentLine = null; // For interactive line/arrow drawing
                
                // Initialize free drawing brushes
                canvasInstance.freeDrawingBrush = new floorPlanWindow.fabric.PencilBrush(canvasInstance);
                canvasInstance.freeDrawingBrush.width = brushWidth;
                canvasInstance.freeDrawingBrush.color = selectedColor;
                
                // Set pencil as default active tool
                const defaultTool = floorPlanWindow.document.querySelector('#pencil');
                if (defaultTool) {
                    defaultTool.classList.add('active');
                    defaultTool.style.backgroundColor = '#e0e0e0';
                }
                
                // Setup initial free drawing
                setupFreeDrawing();

                // Populate script items
                if (camList.length > 0) {
                    const li = camList.map(cam => `<li class="option tool" id="camera-${cam}">
                        <i class="fa-solid fa-camera"></i>
                        <span>Camera ${cam}</span>
                    </li>`).join('');
                    scriptItems.innerHTML = li;
                } else {
                    scriptItems.innerHTML = '';
                }

                //Add selected subjects to the script items
                if (selectedSubjects.length > 0) {
                    const subjectLi = selectedSubjects.map(subject => `<li class="option tool" id="${subject}">
                        <i class="fa-solid fa-user"></i>
                        <span>${subject}</span>
                    </li>`).join('');
                    scriptItems.innerHTML += subjectLi;
                }

                // Mouse event handlers using direct DOM events for better control
                const canvasElement = canvasInstance.lowerCanvasEl;
                
                // Handle free drawing tools (pencil and eraser)
                function setupFreeDrawing() {
                    if (selectedTool === "pencil") {
                        canvasInstance.isDrawingMode = true;
                        canvasInstance.freeDrawingBrush = new floorPlanWindow.fabric.PencilBrush(canvasInstance);
                        canvasInstance.freeDrawingBrush.width = brushWidth;
                        canvasInstance.freeDrawingBrush.color = selectedColor;
                    } else if (selectedTool === "eraser") {
                        canvasInstance.isDrawingMode = true;
                        canvasInstance.freeDrawingBrush = new floorPlanWindow.fabric.PencilBrush(canvasInstance);
                        canvasInstance.freeDrawingBrush.width = brushWidth;
                        canvasInstance.freeDrawingBrush.color = "#ffffff"; // White for eraser
                    } else {
                        canvasInstance.isDrawingMode = false;
                    }
                }
                
                // Keep Fabric.js events for other tools
                canvasInstance.on('mouse:move', function(opt) {
                    if (!isDrawing || !drawMode) return;
                    
                    const pointer = canvasInstance.getPointer(opt.e);
                    
                    // Update interactive line drawing
                    if (selectedTool === "line" && currentLine) {
                        currentLine.set({
                            x2: pointer.x,
                            y2: pointer.y
                        });
                        canvasInstance.renderAll();
                    }
                    
                    // Update interactive arrow drawing
                    if (selectedTool === "arrow" && currentLine) {
                        console.log("Updating arrow...");
                        currentLine.set({
                            x2: pointer.x,
                            y2: pointer.y
                        });
                        canvasInstance.renderAll();
                    }
                });
                
                canvasInstance.on('mouse:up', function(opt) {
                    if (!isDrawing || !drawMode) return;
                    
                    // Finalize interactive line and arrow drawing
                    if ((selectedTool === "line" || selectedTool === "arrow") && currentLine) {
                        if (selectedTool === "arrow") {
                            // Add arrowhead to the line
                            const x1 = currentLine.x1;
                            const y1 = currentLine.y1;
                            const x2 = currentLine.x2;
                            const y2 = currentLine.y2;
                            
                            // Calculate arrowhead
                            const arrowLength = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                            const arrowAngle = Math.atan2(y2 - y1, x2 - x1);
                            const arrowheadLength = Math.min(20, arrowLength * 0.2);
                            const arrowheadAngle = Math.PI / 4; // 45 degrees - wider angle
                            
                            // Create arrowhead lines - start them slightly back from the end point
                            const arrowheadStartDistance = 5; // Start arrowhead 5 pixels back from the end
                            const startX = x2 - arrowheadStartDistance * Math.cos(arrowAngle);
                            const startY = y2 - arrowheadStartDistance * Math.sin(arrowAngle);
                            
                            const head1X = startX - arrowheadLength * Math.cos(arrowAngle - arrowheadAngle);
                            const head1Y = startY - arrowheadLength * Math.sin(arrowAngle - arrowheadAngle);
                            const head2X = startX - arrowheadLength * Math.cos(arrowAngle + arrowheadAngle);
                            const head2Y = startY - arrowheadLength * Math.sin(arrowAngle + arrowheadAngle);
                            
                            const head1 = new floorPlanWindow.fabric.Line([startX, startY, head1X, head1Y], {
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: false,
                                evented: false
                            });
                            
                            const head2 = new floorPlanWindow.fabric.Line([startX, startY, head2X, head2Y], {
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: false,
                                evented: false
                            });
                            
                            // Add arrowhead lines to canvas
                            canvasInstance.add(head1);
                            canvasInstance.add(head2);
                        }
                        
                        // Make the line/arrow selectable and editable
                        currentLine.set({
                            selectable: true,
                            evented: true,
                            hasControls: true,
                            hasBorders: true,
                            lockRotation: false,
                            lockScalingX: false,
                            lockScalingY: false
                        });
                        
                        canvasInstance.setActiveObject(currentLine);
                        currentLine = null;
                        isDrawing = false;
                        lastPoint = null;
                    }
                });
                
                canvasInstance.on('mouse:down', function(opt) {
                    if (!drawMode) return;
                    
                    const pointer = canvasInstance.getPointer(opt.e);
                    
                    if (selectedTool === "text") {
                        // Add text object
                        const text = new floorPlanWindow.fabric.IText('Click to edit', {
                            left: pointer.x,
                            top: pointer.y,
                            fontFamily: 'Arial',
                            fontSize: 20,
                            fill: selectedColor,
                            selectable: true,
                            editable: true
                        });
                        canvasInstance.add(text);
                        canvasInstance.setActiveObject(text);
                        text.enterEditing();
                        return;
                    }
                    
                    // Handle interactive line and arrow drawing
                    if (selectedTool === "line" || selectedTool === "arrow") {
                        console.log("Starting to draw:", selectedTool);
                        isDrawing = true;
                        lastPoint = pointer;
                        
                        if (selectedTool === "line") {
                            currentLine = new floorPlanWindow.fabric.Line([pointer.x, pointer.y, pointer.x, pointer.y], {
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: false,
                                evented: false
                            });
                        } else if (selectedTool === "arrow") {
                            // Just create a simple line like the line tool
                            currentLine = new floorPlanWindow.fabric.Line([pointer.x, pointer.y, pointer.x, pointer.y], {
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: false,
                                evented: false
                            });
                        }
                        
                        canvasInstance.add(currentLine);
                        return;
                    }
                    
                    // Handle shape drawing and other tools
                    if (selectedTool === "rectangle" || selectedTool === "circle" || selectedTool === "triangle" || 
                        selectedTool === "square" || selectedTool === "hexagon" || selectedTool === "pentagon" || 
                        selectedTool.startsWith("camera-") || 
                        (selectedTool !== 'pencil' && selectedTool !== 'eraser' && selectedTool !== 'text')) {
                        drawShape(selectedTool, pointer);
                    }
                });

                // Shape drawing functions
                const drawShape = function(shapeType, pointer) {
                    console.log("Drawing shape:", shapeType, "at", pointer);
                    let shape;
                    
                    switch(shapeType) {
                        case 'rectangle':
                            shape = new floorPlanWindow.fabric.Rect({
                                left: pointer.x,
                                top: pointer.y,
                                width: 100,
                                height: 100,
                                fill: fillColor.checked ? selectedColor : 'transparent',
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: true
                            });
                            break;
                        case 'circle':
                            shape = new floorPlanWindow.fabric.Circle({
                                left: pointer.x,
                                top: pointer.y,
                                radius: 50,
                                fill: fillColor.checked ? selectedColor : 'transparent',
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: true
                            });
                            break;
                        case 'triangle':
                            shape = new floorPlanWindow.fabric.Triangle({
                                left: pointer.x,
                                top: pointer.y,
                                width: 100,
                                height: 100,
                                fill: fillColor.checked ? selectedColor : 'transparent',
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: true
                            });
                            break;

                        case 'square':
                            shape = new floorPlanWindow.fabric.Rect({
                                left: pointer.x,
                                top: pointer.y,
                                width: 100,
                                height: 100,
                                fill: fillColor.checked ? selectedColor : 'transparent',
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: true
                            });
                            break;
                        case 'hexagon':
                            const hexPoints = [];
                            for (let i = 0; i < 6; i++) {
                                const angle = (2 * Math.PI / 6) * i;
                                const x = pointer.x + 50 * Math.cos(angle);
                                const y = pointer.y + 50 * Math.sin(angle);
                                hexPoints.push({x: x, y: y});
                            }
                            shape = new floorPlanWindow.fabric.Polygon(hexPoints, {
                                fill: fillColor.checked ? selectedColor : 'transparent',
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: true
                            });
                            break;
                        case 'pentagon':
                            const pentPoints = [];
                            for (let i = 0; i < 5; i++) {
                                const angle = (2 * Math.PI / 5) * i - Math.PI / 2;
                                const x = pointer.x + 50 * Math.cos(angle);
                                const y = pointer.y + 50 * Math.sin(angle);
                                pentPoints.push({x: x, y: y});
                            }
                            shape = new floorPlanWindow.fabric.Polygon(pentPoints, {
                                fill: fillColor.checked ? selectedColor : 'transparent',
                                stroke: selectedColor,
                                strokeWidth: brushWidth,
                                selectable: true
                            });
                            break;
                        case 'camera':
                            // Handle camera tools (camera-1, camera-2, etc.)
                            if (selectedTool.startsWith('camera-')) {
                                const cameraNumber = selectedTool.replace('camera-', '');
                                const cameraCircle = new floorPlanWindow.fabric.Circle({
                                    left: pointer.x,
                                    top: pointer.y,
                                    radius: 30,
                                    fill: fillColor.checked ? selectedColor : 'transparent',
                                    stroke: selectedColor,
                                    strokeWidth: 2,
                                    selectable: true
                                });
                                
                                const cameraText = new floorPlanWindow.fabric.Text(cameraNumber, {
                                    left: pointer.x,
                                    top: pointer.y,
                                    fontSize: 16,
                                    fill: selectedColor,
                                    originX: 'center',
                                    originY: 'center',
                                    selectable: false
                                });
                                
                                canvasInstance.add(cameraCircle);
                                canvasInstance.add(cameraText);
                                return;
                            }
                            break;
                        default:
                            // Subject or other tool
                            if (selectedTool !== 'pencil' && selectedTool !== 'eraser' && selectedTool !== 'text') {
                                const subjectCircle = new floorPlanWindow.fabric.Circle({
                                    left: pointer.x,
                                    top: pointer.y,
                                    radius: 30,
                                    fill: fillColor.checked ? selectedColor : 'transparent',
                                    stroke: selectedColor,
                                    strokeWidth: brushWidth,
                                    selectable: true
                                });
                                
                                const subjectText = new floorPlanWindow.fabric.Text(selectedTool, {
                                    left: pointer.x,
                                    top: pointer.y,
                                    fontSize: 12,
                                    fill: selectedColor,
                                    originX: 'center',
                                    originY: 'center',
                                    selectable: false
                                });
                                
                                                            canvasInstance.add(subjectCircle);
                            canvasInstance.add(subjectText);
                                return;
                            }
                            return;
                    }
                    
                    if (shape) {
                        canvasInstance.add(shape);
                        canvasInstance.setActiveObject(shape);
                    }
                };

                // Tool selection logic
                toolBtns.forEach(btn => {
                    btn.addEventListener("click", () => {
                        selectTool(btn);
                    });
                });

                // Function to handle tool selection
                function selectTool(toolElement) {
                    // Remove active class from all tools
                    floorPlanWindow.document.querySelectorAll(".tool").forEach(tool => {
                        tool.classList.remove("active");
                        tool.style.backgroundColor = '';
                    });
                    toolElement.classList.add("active");
                    toolElement.style.backgroundColor = '#e0e0e0';
                    selectedTool = toolElement.id;
                    console.log("Selected tool:", selectedTool);
                    
                    // Setup free drawing for pencil/eraser
                    if (drawMode) {
                        setupFreeDrawing();
                    }
                }
                
                // Add event delegation only for dynamically added tools (cameras and subjects)
                floorPlanWindow.document.addEventListener("click", (e) => {
                    const clickedTool = e.target.closest('.tool');
                    if (clickedTool && (clickedTool.id.startsWith('camera-') || !Array.from(toolBtns).includes(clickedTool))) {
                        selectTool(clickedTool);
                    }
                });

                sizeSlider.addEventListener("change", () => {
                    brushWidth = parseInt(sizeSlider.value);
                    if (canvasInstance.freeDrawingBrush) {
                        canvasInstance.freeDrawingBrush.width = brushWidth;
                    }
                });

                colorBtns.forEach(btn => {
                    btn.addEventListener("click", () => {
                        floorPlanWindow.document.querySelector(".options .selected")?.classList.remove("selected");
                        btn.classList.add("selected"); 
                        selectedColor = floorPlanWindow.getComputedStyle(btn).getPropertyValue("background-color");
                    });
                });

                colorPicker.addEventListener("change", () => {
                    selectedColor = colorPicker.value;
                    if (canvasInstance.freeDrawingBrush && selectedTool === "pencil") {
                        canvasInstance.freeDrawingBrush.color = selectedColor;
                    }
                });

                clearCanvas.addEventListener("click", () => {
                    canvasInstance.clear();
                    canvasInstance.backgroundColor = '#ffffff';
                    canvasInstance.renderAll();
                });

                saveImage.addEventListener("click", () => {
                    const link = floorPlanWindow.document.createElement("a");
                    link.download = `${Date.now()}.jpg`;
                    link.href = canvasInstance.toDataURL();
                    link.click();
                });

                addSubject.addEventListener("click", () => {
                    const newSubject = floorPlanWindow.document.getElementById("newSub").value;

                    if(scriptItems.innerHTML === "") {
                        scriptItems.innerHTML = `<li class="option tool" id="${newSubject}">
                        <i class="fa-solid fa-user"></i>
                        <span>${newSubject}</span>
                    </li>`;
                    } else {
                        scriptItems.innerHTML += `<br /><li class="option tool" id="${newSubject}">
                        <i class="fa-solid fa-user"></i>
                        <span>${newSubject}</span>
                    </li>`;
                    }
                });

                // Mode button event handlers
                drawModeBtn.addEventListener("click", () => {
                    drawMode = true;
                    drawModeBtn.classList.add("active");
                    selectModeBtn.classList.remove("active");
                    console.log("Switched to Draw Mode");
                    
                    // Disable selection in draw mode
                    canvasInstance.selection = false;
                    canvasInstance.forEachObject(function(obj) {
                        obj.selectable = false;
                    });
                    
                    // Set drawing cursor
                    canvasInstance.defaultCursor = 'crosshair';
                    canvasInstance.hoverCursor = 'crosshair';
                    
                    // Setup free drawing for current tool
                    setupFreeDrawing();
                });

                selectModeBtn.addEventListener("click", () => {
                    drawMode = false;
                    selectModeBtn.classList.add("active");
                    drawModeBtn.classList.remove("active");
                    console.log("Switched to Select Mode");
                    
                    // Enable selection in select mode
                    canvasInstance.selection = true;
                    canvasInstance.forEachObject(function(obj) {
                        obj.selectable = true;
                    });
                    
                    // Set selection cursor
                    canvasInstance.defaultCursor = 'default';
                    canvasInstance.hoverCursor = 'move';
                    
                    // Disable free drawing
                    canvasInstance.isDrawingMode = false;
                });
                
            }
            
            //Initialization after document is ready
            if (floorPlanWindow.document.readyState === 'loading') {
                floorPlanWindow.document.addEventListener('DOMContentLoaded', initializeFloorPlan);
            } else {
                //Delay to ensure DOM is fully ready
                setTimeout(initializeFloorPlan, 100);
            }
        }

      //ADD INSERT
      $('.addInsert-button').on('click', function() {
            var selection = window.getSelection();
            var targetRow;

            if (selection.rangeCount > 0) {
                var range = selection.getRangeAt(0);
                //First try to find the closest td, then find its parent tr
                var cell = range.commonAncestorContainer.nodeType === 1 
                    ? range.commonAncestorContainer.closest('td')?.closest('tr')
                    : range.commonAncestorContainer.parentElement.closest('td')?.closest('tr');
                if (cell) {
                    targetRow = $(cell);
                    var newRow = $('<tr class="insert_highlighted">' +
                        '<td contenteditable="false" style="text-align:center"></td>' +
                        '<td contenteditable="true" style="text-align:center"></td>' +
                        '<td contenteditable="true">' + createInsertCell() + '</td>' +
                        '<td contenteditable="true" style="text-align:center"></td>' +
                        '<td style="border:none; width:90px">' + createRowButtons() + '</td>' +
                    '</tr>');
                    
                    $(newRow).insertAfter(targetRow);
                    updateEventNumbers();
                    initDraggable(); //Make it draggable
                    return;
                }
            }

            //If no selection, create new row at the end
            var newRow = '<tr class="insert_highlighted">' +
                '<td contenteditable="false" style="text-align:center"></td>' +
                '<td contenteditable="true" style="text-align:center"></td>' +
                '<td contenteditable="true">' + createInsertCell() + '</td>' +
                '<td contenteditable="true" style="text-align:center"></td>' +
                '<td style="border:none; width:90px">' + createRowButtons() + '</td>' +
            '</tr>';
            $('#event-table tbody').append(newRow);
            updateEventNumbers();
            
            //Initialize draggable on the newly added row
            initDraggable();


        });


      //ADD ITEM
      $('.addItem-button').on('click', function() {
        var selection = window.getSelection();
        
        var newRow = $(`<tr class="item_highlighted">
            <td contenteditable="false" style="text-align:center"></td>
            <td contenteditable="true"></td>
            <td contenteditable="false">
                <div class="item-cell-container">
                    <span contenteditable="false" style="text-decoration: underline;"><b>ITEM ${$('#event-table tbody tr.item_highlighted').length + 1}: &nbsp</b></span>
                    <input type="text" class="item-content" name="itemContent" autocomplete="off" placeholder="New Item" style="background-color: black; margin-left: -15px;">
                </div>
            </td>
            <td contenteditable="true" style="text-align:center"></td>
            <td style="border:none; width:90px">${createRowButtons()}</td>
        </tr>`);
        
        //If there is a selection, add the item after the selected row
        if (selection.rangeCount > 0) {
            var range = selection.getRangeAt(0);
            var cell = range.commonAncestorContainer.nodeType === 1 
                ? range.commonAncestorContainer.closest('td')?.closest('tr')
                : range.commonAncestorContainer.parentElement.closest('td')?.closest('tr');
            
            if (cell) {
                $(cell).after(newRow);
                updateItemNumbers();
                initDraggable();
                return;
            }
        }
        else {
            //If no selection, append to end of table
            $('#event-table tbody').append(newRow);
            updateItemNumbers();
            initDraggable();
            return;
        }   
    
        $('.addItem-button').trigger('click');
       
        
    });



  //RUNNING ORDER
  $(document).on('click', '.runningOrder-button', function() { 
      const showScriptButton = $('<button class="btn button2" title="Show Script"><i class="fas fa-list-ol"></i> Show Script</button>');
      
      //Store the original content
      const originalContent = $('.container').html();
      
      //Store all input values before switching views
      const storedInputs = {
          itemContents: $('.item-content').map(function() {
              return $(this).val() || $(this).text();
          }).get(),
          insertInputs: $('.insertTitle, .insertIn, .insertOut').map(function() {
              return $(this).val() || $(this).text();
          }).get(),
          eventInputs: $('.cameraNum, .cameraPos, .shotSubject, .extraInfo, .shot-type-select').map(function() {
              return $(this).val() || $(this).text();
          }).get(),
          timeInputs: $('input[type="time"]').map(function() {
              return $(this).val();
          }).get()
      };

      //Event > Item numbers
      const eventNumbers = [];
      const itemNumbers = [];
      const sourceType = [];
      const soundSource = [];
      const itemLength = [];
      const accumulatedTime = [];
      const timeStore = [];
      const itemTitle = [];
      let accumulatedCalc = 0;

      //Calculate how long it would take for dialogue to be spoken
      function wordCalulation(content) { //Passes in the dialogue in the event
        const wordCount = content.trim().split(' ').length; //Get word count
        const wordsPerSecond = 2.5; //Average words per second
        const totalSeconds = wordCount * wordsPerSecond; 
        //Call the function to convert this to a time format
        return timeConvert(totalSeconds); 
      }

      function secondCalc(time) {
        const timeString = String(time).trim();
        const timeFormat = timeString.split(':');
        const minutes = parseInt(timeFormat[0], 10);
        const seconds = parseInt(timeFormat[1], 10);
        const totalSeconds = minutes * 60 + seconds;
        return totalSeconds;
      }

      //Convert time in seconds to '00:00' format for running order
      function timeConvert(time) {
        const totalSeconds = Math.round(time); //Round total seconds
        const minutes = Math.floor(totalSeconds / 60); //Convert seconds to minutes
        const seconds = totalSeconds % 60; //Get the remainder seconds
        //Return this in a '00:00' format
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }

      let currentItem = null;

      //Find all item rows and their indices
      const itemRows = [];
      $('#event-table tbody tr').each(function(index) {
          if ($(this).hasClass('item_highlighted')) {
              itemRows.push({
                  index: index,
                  itemNumber: $(this).find('td:nth-child(3)').text().match(/ITEM\s+(\d+)/i)?.[1]
              });
          }
      });

      //Process rows between each pair of items
      for (let i = 0; i < itemRows.length; i++) {
          const currentItem = itemRows[i];
          const nextItem = itemRows[i + 1];
          const startIndex = currentItem.index + 1;
          const endIndex = nextItem ? nextItem.index : $('#event-table tbody tr').length;

          //Get the item title and push it into the list
          const itemContent = $('#event-table tbody tr').eq(currentItem.index)
              .find('.item-content')
              .map(function() {
                  //Try getting value first, then fall back to text content
                  return $(this).val() || $(this).text();
              })
              .get(0)
              .trim();
          itemTitle[currentItem.itemNumber - 1] = itemContent;
          itemNumbers.push(currentItem.itemNumber);
          
          //Initialize total time for item
          let totalSeconds = 0;
          let hasVT = false;

          //Process rows between current item and next item 
          for (let j = startIndex; j < endIndex; j++) {
              const row = $('#event-table tbody tr').eq(j);
              const hasEvent = row.find('td:nth-child(2)').text().trim().length > 0;
              const hasInsert = row.find('input[type="time"]').length > 0;

              if (hasEvent) {
                  //Calculate timing based on word count for events
                  const scriptCell = row.find('td:nth-child(3)');
                  const content = scriptCell.clone()
                      .find('.cut-line').remove().end()
                      .text()
                      .trim();
                  
                  const wordCount = content ? content.split(' ').length : 0;
                  const wordsPerSecond = 2.5;
                  totalSeconds += wordCount * wordsPerSecond;
              } else if (hasInsert) {
                  hasVT = true;
                  //Add insert duration
                  const durationInput = row.find('input[type="time"]');
                  if (durationInput.length > 0 && durationInput.val()) {
                      const [minutes, seconds] = durationInput.val().split(':');
                      totalSeconds += parseInt(minutes) * 60 + parseInt(seconds);
                  }
              }
          }

          //Push all data for this item
          sourceType.push(hasVT ? "VT" : "CAMS");
          soundSource.push(hasVT ? "VT" : "");
          itemLength.push(timeConvert(totalSeconds));
      }

      function accumulatedTimeCalc() {
        for(let i = 0; i < itemLength.length; i++) {
          if(i == 0) {
            accumulatedTime.push(timeConvert(secondCalc(itemLength[i])));
          } else {
            accumulatedTime.push(timeConvert(secondCalc(itemLength[i]) + secondCalc(accumulatedTime[i-1])));
          }
        }
     }

      accumulatedTimeCalc();
      
      $('.container').html(`
          <head>
              <style>
                  /* Change styling of last header column in running order */
                  #runningOrder-table thead tr th:last-child {
                      /* better contrast for accessibility */
                      background-color: #2c3e50 !important;
                      color: #ffffff !important;
                      border-radius: 12px 12px 0 0;
                      
                      /* Text styling for better readability */
                      text-align: center !important;
                      vertical-align: middle !important;
                      height: 56px !important;
                      line-height: 150% !important;
                      font-weight: 700 !important;
                      text-transform: uppercase !important;
                      font-size: 16px !important;
                      letter-spacing: 0.7px !important;
                      border-bottom: 3px solid #34495e !important;
                      box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
                      padding: 12px 16px !important;
                  }
              </style>
          </head>
          <body>
              <table style="margin-top:100px; text-align:center;" id="runningOrder-table" class="table">
                  <thead>
                      <tr>
                          <th style="width:8%;">ITEM NUM.</th>
                          <th style="width:12%;">SOURCE</th>
                          <th style="width:40%;">CONTENT</th>
                          <th style="width:20%;">SOUND</th>
                          <th style="width:10%;">ITEM TIME</th>
                          <th style="width:10%;">ACC. TIME</th>
                          <th style="width:10%;">ACTUAL TIME</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${itemNumbers.map(num => `
                          <tr>
                              <td contenteditable="false">${num}</td>
                              <td contenteditable="true">${sourceType[num-1]}</td>
                              <td contenteditable="true" style="text-align:left; margin-left: 50px;">${itemTitle[num-1]}</td>
                              <td contenteditable="true">${soundSource[num-1]}</td>
                              <td contenteditable="false">${itemLength[num-1]}</td>
                              <td contenteditable="false">${accumulatedTime[num-1]}</td>
                              <td contenteditable="true"></td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          </body>
      `);

      //Remove any existing show script buttons first
      $('.toolbar-group .showScript-button').remove();
      
      //Remove the running order button
      $('.runningOrder-button').remove();
      
      //Attach click handler to show script button
      showScriptButton.on('click', function() {
          $('.container').html(originalContent);
          
          //Restore item content values using the stored inputs
          $('.item-content').each(function(index) {
              if (storedInputs.itemContents[index]) {
                  $(this).val(storedInputs.itemContents[index]);
              }
          });

          //Restore insert input values
          $('.insertTitle, .insertIn, .insertOut').each(function(index) {
              if (storedInputs.insertInputs[index]) {
                  $(this).val(storedInputs.insertInputs[index]);
              }
          });

          //Restore time input values
          $('input[type="time"]').each(function(index) {
              if (storedInputs.timeInputs[index]) {
                  $(this).val(storedInputs.timeInputs[index]);
              }
          });

          //Restore event values
          $('.cameraNum, .cameraPos, .shotSubject, .extraInfo, .shot-type-select').each(function(index) {
              if (storedInputs.eventInputs[index]) {
                  $(this).val(storedInputs.eventInputs[index]);
              }
          });

          initDraggable();

          $(this).remove();
          const runningOrderButton = $('<button class="btn button2 runningOrder-button" title="Running Order"><i class="fas fa-list-ol"></i> Running Order</button>');
          $('.toolbar-group.dynamic-buttons').append(runningOrderButton);
      });

      //Add the show script button
      $('.toolbar-group.dynamic-buttons').append(showScriptButton);
  });


  //Pop up question modal
  function showQuestionModal(question, option1Text, option2Text, option1Callback, option2Callback) {
    const modalElement = document.getElementById('questionModal');
    const modal = new bootstrap.Modal(modalElement);
    
    //Set the question
    document.querySelector('#questionModal .modal-body').textContent = question;
    
    //Set button text
    const option1Button = document.getElementById('modalOption1');
    const option2Button = document.getElementById('modalOption2');
    option1Button.textContent = option1Text;
    option2Button.textContent = option2Text;
    
    //Store the element that had focus before opening the modal
    const previousActiveElement = document.activeElement;
    
    //Set up button click handlers
    option1Button.onclick = function() {
      modal.hide();
      option1Callback();
      //Return focus to the previous element
      if (previousActiveElement) {
        previousActiveElement.focus();
      }
    };
    option2Button.onclick = function() {
      modal.hide();
      option2Callback();
      //Return focus to the previous element
      if (previousActiveElement) {
        previousActiveElement.focus();
      }
    };
    
    //Handle modal events
    modalElement.addEventListener('hidden.bs.modal', function () {
      //Return focus to the previous element when modal is hidden
      if (previousActiveElement) {
        previousActiveElement.focus();
      }
    }, { once: true });
    
    modal.show();
  }


  function formatTime(event) {
      //Allow only numbers, backspace, delete, tab, arrows, and colon
      if (!(['0','1','2','3','4','5','6','7','8','9','Backspace','Delete','Tab','ArrowLeft','ArrowRight',':'].includes(event.key))) {
          event.preventDefault();
          return false;
      }
  }

  function formatTimeInput(element) {
      let value = element.textContent.replace(/[^\d]/g, ''); //Remove non-digits
      
      //Pad with zeros if necessary
      while (value.length < 4) {
          value = '0' + value;
      }
      
      //Limit to 4 digits
      value = value.slice(0, 4);
      
      //Format as MM:SS
      const minutes = value.slice(0, 2);
      const seconds = value.slice(2, 4);
      
      //Validate seconds
      if (parseInt(seconds) > 59) {
          element.textContent = minutes + ':59';
      } else {
          element.textContent = minutes + ':' + seconds;
      }
  }

  //If CUSTOM option selected on dropdown, insert an editable cell instead
  $(document).on('change', '.shot-type-select', function() {
      const select = $(this);
      const input = select.siblings('.custom-shot-type');
      if (select.val() === 'CUSTOM') {
          select.hide();
          input.show().focus();
      }
  });

  //Event handler for the CUSTOM input
  $(document).on('blur', '.custom-shot-type', function() {
      const input = $(this);
      const select = input.siblings('.shot-type-select');
      if (!input.val().trim()) {
          input.hide();
          select.show().val('SHOT TYPE');
      }
  });

  //DRAGGABLE FUNCTION
  function initDraggable() {
      const tbody = document.querySelector('#event-table tbody');
      
      //Enable drag only on drag buttons
      tbody.querySelectorAll('.row-button.drag').forEach(button => {
          const row = button.closest('tr');
          //Make the drag button the drag handle
          button.draggable = true; 
          
          //Handle drag events on the button
          button.addEventListener('dragstart', (e) => {
              row.classList.add('dragging');
              e.dataTransfer.setData('text/plain', '');
              e.dataTransfer.effectAllowed = 'move';
          });
          
          button.addEventListener('dragend', () => {
              row.classList.remove('dragging');
              updateItemNumbers();
          });
      });
      
      //Swap two
      tbody.addEventListener('dragover', e => {
          e.preventDefault();
          const draggingRow = tbody.querySelector('.dragging');
          if (!draggingRow) return;
          
          const siblings = [...tbody.querySelectorAll('tr:not(.dragging)')];
          const nextSibling = siblings.find(sibling => {
              const box = sibling.getBoundingClientRect();
              return e.clientY < box.top + box.height / 2;
          });
          
          if (nextSibling) {
              tbody.insertBefore(draggingRow, nextSibling);
              var draggedEventNum = draggingRow.querySelector('td:first-child').textContent;
              var replacementEventNum = nextSibling.querySelector('td:first-child').textContent;
              
          } else {
              tbody.appendChild(draggingRow);
              const draggedEventNum = draggingRow.querySelector('td:first-child').textContent;
          }
          updateEventNumbers();
          updateItemNumbers();
      });
  }


  //Initialize draggable on page load
  initDraggable();
  
  //Make rows remain draggable when order is rearranged
  $(document).on('click', '.row-button.drag, .addEvent-button, .addInsert-button, .addItem-button', function() {
      setTimeout(initDraggable, 0);
  });

  //Close dropdown when clicking outside
  $(document).on('click', function(e) {
      if (!$(e.target).closest('.dropdown').length) {
          $('.dropdown').removeClass('active');
      }
  });

  //Initialise item row
  $('.addItem-button').trigger('click');
  });
</script>
</body>
</html>