<!DOCTYPE html>
<html lang="en">
<head>
  <title>Studio Script Writer</title>
  <style>
    body {
      padding-top: 70px;
    }

    /* Hide the main content by default */
    .main-content {
      display: none;
    }

    table {
      width: 794px !important;
      table-layout: fixed;
      margin: 0 auto;
    }

    td[contenteditable='true'],
    div[contenteditable='true'] {
        border: 0px solid rgb(214, 235, 255);
    } 

    .table .shot-type-select {
      width: fit-content;
      text-align: left;
      border: 0px solid rgb(214, 235, 255);
      outline: 1px solid blue;
    }

    /*Nav bar that has a fixed position at top of page*/
    ul {
      list-style-type: none;
      margin: 0;
      padding: 25px;
      overflow: hidden;
      background-color: rgb(70, 70, 70); 
      position: fixed; 
      top: 0;
      width: 100%;
      z-index: 1000; /* Nav bar is above content of page */
    }

    li {
      float: right;
    }

    .button2 {
      background-color: rgb(70, 70, 70) !important;
      color: white !important;
      padding: 15px 32px;
      text-align: center;
      display: inline-block;
      font-size: 16px;
    }

    .button2:hover {
      background-color: black !important;
      color: white !important;
    }

    .editable-cell,
    .editable-text,
    div[contenteditable='true'] {
      display: block;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
      outline: 0.5px solid blue;
      min-height: 24px; /* Add minimum height */
      user-select: text; /* Allow text selection only */
    }

    .editable-cell span {
      display: inline-block;
      position: relative;
      width: 100%;
    }

    .editable-cell span::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 3px;
      width: 100%;
      height: 1px;
      background-color: black;
      outline: 1px solid blue;
    }

    .cut-line {
      position: relative;
    }
    
    .cut-line::after {
      content: '';
      position: absolute;
      left: -400px; 
      right: 0; 
      bottom: -3px;
      height: 2px;
      background-color: black;
      z-index: 1;
      pointer-events: none;
    }

    .shot-type-flex-container {
        display: flex;
        align-items: center;
        gap: 4px; /* Add gap between shot type and subject in view mode */
    }
    
    .shot-type-text {
        flex-grow: 1;
        margin-left: 8px;
    }
    
    .shot-type-dropdown {
        flex-shrink: 0;
        margin-right: 6px; /* Add small margin to separate from subject */
    }

    .shotSubject {
        flex: 1; /* Control gap between shot type and shot subject */
        min-width: 0; /* Prevents flex item from overflowing */
    }

    .modal-dialog {
      margin-top: 15%;
      text-align: center;
    }
    .modal-footer {
      justify-content: center !important;
      text-align: center;
      gap: 15px;
    }


  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>

<body>
  <!-- Login Form -->
  <div id="login-form" style="text-align:center;">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button id="loginButton">Login</button>
  </div>

  <!-- Project Login Form -->
  <div id="project-login" style="text-align:center;">
    <h2>Project Name:</h2>
    <input type="text" id="projectName" placeholder="Enter Project Name"><br><br>
    <button id="projectLogBtn">Select</button>
  </div>

  <!-- Main Page -->
  <div class="main-content">
    <ul>
      <li style="float: right;"><button class="btn button2 view-button">VIEW</button></li> 
      <li style="float: right; margin-left: 100px;"><button class="btn button2 save-button">SAVE</button></li>
      <li style="float: left; margin-left: 10px; margin-right: 10px;"><button class="btn button2 textBold-button">B</button></li>
      <li style="float: left; margin-left: 20px; margin-right: 10px;"><button class="btn button2 textItalic-button">I</button></li>
      <li style="float: left; margin-left: 30px; margin-right: 10px;"><button class="btn button2 textUnderline-button">U</button></li>
      <li style="float: left; margin-right: 10px;"><button class="btn button2 undo-button">UNDO</button></li>
      <li style="float: left; margin-right: 10px;"><button class="btn button2 redo-button">REDO</button></li>
      <li style="float: right; margin-left: 10px;"><button class="btn button2 addCut-button">ADD CUT</button></li>     
      <li style="float: right; margin-left: 10px;"><button class="btn button2 add-item-button">ADD ITEM</button></li>
      <li style="float: right; margin-left: 10px;"><button class="btn button2 addEvent-button">ADD EVENT</button></li>
      

    </ul>

    <div class="square"></div>

    <div class="container">
      <table style="margin-top:100px;" id="event-table" class="table">
          <thead>
              <tr>
                  <th scope="col" style="border: 1px solid black; width:100px; text-align: center;">Event number</th>
                  <th scope="col" style="border: 1px solid black; width:350px; text-align: center;">Shot</th>
                  <th scope="col" style="border: 1px solid black; width:450px; text-align: center;">Script</th>
                  <th scope="col" style="border: 1px solid black; width:150px; text-align: center;">Details</th>
                  <th scope="col" style="border: none; width:100px; text-align: center;"></th>
              </tr>
          </thead>
          <tbody>
          </tbody>
      </table>
    </div>
  </div>

  <!-- Question pop up -->
  <div class="modal fade" id="questionModal" tabindex="-1" role="dialog" aria-labelledby="questionModalLabel" aria-modal="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="questionModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modalOption1"></button>
          <button type="button" class="btn btn-primary" id="modalOption2"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script type="text/javascript">
    //checks if user is already logged in
    window.onload = function() {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const projectName = sessionStorage.getItem('projectName');
        
        if (isLoggedIn === 'true') {
            $('#login-form').hide();
            if (projectName) {
                $('#project-login').hide();
                $('.main-content').show();
            } else {
                $('#project-login').show();
            }
        }
    };

    function preventDeletion(event, defaultContent) {
      const element = event.target;
      const row = element.closest('tr');
      
      
      // Use setTimeout to get the updated content after the current event cycle
      setTimeout(() => {
        const shotSubject = row.querySelector('.shotSubject');
        const cameraType = row.querySelector('.cameraType');
        const extraInfo = row.querySelector('.extraInfo');

        // Check if any of the cells are empty
        if (shotSubject.textContent.length === 0) {
          // Restore the previous content
          shotSubject.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); // false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }

        if (cameraType.textContent.length === 0) {
          // Restore the previous content
          cameraType.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); // false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }

        if (extraInfo.textContent.length === 0) {
          // Restore the previous content
          extraInfo.textContent = '\u00A0';
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(shotSubject);
          range.collapse(false); // false means collapse to end
          selection.removeAllRanges();
          selection.addRange(range);     
        }
      }, 0);
          
          
    }
    

    var role;
    $('#project-login').hide();

    document.getElementById('loginButton').addEventListener('click', function() {
      login();
    });

    document.getElementById('projectLogBtn').addEventListener('click', function() {
      projectLogin();
    });

    function login() {
      const usernameInput = document.querySelector("#username");
      const passwordInput = document.querySelector("#password");

      function usernameCheck(json_file) { //A json file needs to be passed in
          fetch(json_file, {method: 'GET'}) //Get the file
              .then(response => response.json()) //Put them in json format
              .then(result => {
                  const usernameList = result.usernames.map(element => {
                      return element.toLowerCase() //Turns it to lower case
                  })

                  const passwordList = result.passwords.map(element => {
                    return element.toLowerCase() //Turns it to lower case
                  })

                  const targetUsername = usernameInput.value.toLowerCase();
                  const targetPassword = passwordInput.value.toLowerCase();
                  let authenticated = false;

                  for(let i = 0; i < usernameList.length; i++) {
                      if(targetUsername === usernameList[i] && targetPassword === passwordList[i]) {
                          $('#login-form').hide();
                          $('#project-login').show();
                          authenticated = true;
                          // Add these lines to store login state
                          sessionStorage.setItem('isLoggedIn', 'true');
                          sessionStorage.setItem('username', targetUsername);
                          break;
                      }
                  }

                  if(!authenticated) {
                    alert("Username or password is incorrect");
                  } 
              })
              .catch(error => console.log("Error", error)) //Error handling
          }
        
        var username = document.getElementById('username').value;
        var password = document.getElementById('password').value;
    
        usernameCheck("userPass.json"); //Use the function above
    }

    function projectLogin() {
      var projectName = document.getElementById('projectName').value;

      function projectCheck(json_file) { //A json file needs to be passed in
        fetch(json_file, {method: 'GET'}) //Get the file
            .then(response => response.json()) //Put them in json format
            .then(result => {
              const projectList = result.productions.map(element => {
                  return element 
              })
              const targetProject = projectName.toLowerCase();
              
              let authenticated = false;

              for(let i = 0; i < projectList.length; i++) {
                if(targetProject === projectList[i]['name'] && projectList[i]['users'].includes(document.getElementById('username').value)) {
                    $('#project-login').hide();
                    $('.main-content').show();
                    authenticated = true;
                    // Add this line to store project name
                    sessionStorage.setItem('projectName', targetProject);
                    break;
                }
              }

              if(!authenticated) {
                alert("Production does not exist or you do not have access");
              } 
            })
            .catch(error => console.log("Error", error)) //Error handling
        }

        projectCheck("productions.json"); //Use the function above
    }
    
    $(document).ready(function() {
        var highlight = true;
        var cutLine = true;

        var tableData = [
            { eventNum: '1', shotType: '', content: 'Add your script here and add an extra line', details: 'E.g., Music Cues' },
        ];

        var dropdownOptions = ['SHOT TYPE', 'ES', 'WS', '2S', '3S', 'MS', 'MCU', 'CU', 'ECU', 'AS DIRECTED'];

        function createShotTypeCell(shotType, firstTime) {
            var selectHTML = '<select class="form-control shot-type-select">';
            dropdownOptions.forEach(function(option) {
                var optionValue = option || '';  
                var isSelected = optionValue === (shotType || '');  
                selectHTML += '<option value="' + optionValue + '"' + (isSelected ? ' selected' : '') + '>' + optionValue + '</option>';
            });
            selectHTML += '</select>';

            var placeHolderText1 = firstTime ? 'Camera Number/Position' : '\u00A0';
            var placeHolderText2 = firstTime ? 'Shot Subject (E.g., HOST)' : '\u00A0';
            var placeHolderText3 = firstTime ? 'Additional Info (E.g., TRACK OUT)' : '\u00A0';

            return '<div>' +
                '<div class="editable-cell cameraType" contenteditable="true" onkeydown="preventDeletion(event, \'' + placeHolderText1 + '\')">' + placeHolderText1 + '</div>' +
                '<div class="shot-type-flex-container">' +
                    '<div class="shotTypeDropdown">' + selectHTML + '</div>' +
                    '<div class="editable-text shotSubject" contenteditable="true" onkeydown="preventDeletion(event, \'' + placeHolderText2 + '\')" >' + placeHolderText2 + '</div>' +
                '</div>' +
                '<div class="editable-cell extraInfo" contenteditable="true" onkeydown="preventDeletion(event, \'' + placeHolderText3 + '\')">' + placeHolderText3 + '</div>' +
            '</div>';
        }

        function updateEventNumbers() {
          let eventNumber = 1;
          $('#event-table tbody tr').each(function() {
              // Check if there is an event in the row (If Shot column has any content)
              const hasContent = $(this).find('td:nth-child(2)').text().trim().length > 0;
              
              if (hasContent) {
                  $(this).find('td:first').text(eventNumber);
                  eventNumber++;
              } else {
                  $(this).find('td:first').text('');
              }
          });
        }

        // Populate the table with data on document ready
        tableData.forEach(function(row) {
            var newRow = '<tr>' +
                '<td contenteditable="true"; style="text-align:center";>' + row.eventNum + '</td>' +
                '<td contenteditable="true";>' + createShotTypeCell("SHOT TYPE", true) + '</td>' +
                '<td contenteditable="true">' + row.content + '</td>' +
                '<td contenteditable="true"; style="text-align:center";>' + row.details.replace('\n','<br>') + '</td>' +
                '<td style="border:none; width:100px"><button class="btn btn-primary add-button">+</button><button class="btn btn-danger remove-button">-</button></td>' +
                '</tr>';
            $('#event-table tbody').append(newRow);
        });

        //ADD NEW ROW
        $(document).on('click', '.add-button', function() {
          var newRow = '<tr>' +
                '<td contenteditable="true"; style="text-align:center";></td>' +
                '<td contenteditable="true"></td>' +
                '<td contenteditable="true"></td>' +
                '<td contenteditable="true"; style="text-align:center";></td>' +
                '<td style="border: none"><button class="btn btn-primary add-button">+</button><button class="btn btn-danger remove-button">-</button></td>' +
                '</tr>';
            $(this).closest('tr').after(newRow);
        });

        //REMOVE ROW
        $(document).on('click', '.remove-button', function() {
            if ($('#event-table tbody tr').length > 1) {
                $(this).closest('tr').remove();
                updateEventNumbers();
            }
        });
        
        //ADD EVENT 
        $('.addEvent-button').on('click', function() {
            var selection = window.getSelection();
            var targetRow;

            if (selection.rangeCount > 0) {
                var range = selection.getRangeAt(0);
                // First try to find the closest td, then find its parent tr
                var cell = range.commonAncestorContainer.nodeType === 1 
                    ? range.commonAncestorContainer.closest('td')?.closest('tr')
                    : range.commonAncestorContainer.parentElement.closest('td')?.closest('tr');
                if (cell) {
                    targetRow = $(cell);
                    // Populate the selected row with new event content
                    targetRow.find('td:eq(1)').html(createShotTypeCell("SHOT TYPE", false));
                    targetRow.find('td:eq(2)').empty(); // Clear script cell
                    targetRow.find('td:eq(3)').empty(); // Clear details cell
                    updateEventNumbers();
                    return; // Exit early since we've updated the existing row
                }
            }

            // If no selection, create new row at the end
            var newRow = '<tr>' +
                '<td contenteditable="true"; style="text-align:center";></td>' +
                '<td contenteditable="true";>' + createShotTypeCell("SHOT TYPE", false) + '</td>' +
                '<td contenteditable="true"></td>' +
                '<td contenteditable="true"; style="text-align:center";></td>' +
                '<td style="border:none; width:100px"><button class="btn btn-primary add-button">+</button><button class="btn btn-danger remove-button">-</button></td>' +
                '</tr>';
            $('#event-table tbody').append(newRow);
            updateEventNumbers();
        });

        //UNDERLINE
        $('.textUnderline-button').on('click', function() {
          document.execCommand('underline', false, null);
        });

        //BOLD
        $('.textBold-button').on('click', function() {
          document.execCommand('bold', false, null);
        });

        //ITALIC
        $('.textItalic-button').on('click', function() {
          document.execCommand('italic', false, null);
        });

        //ADD CUT ON CLICK
        $('.addCut-button').on('click', function() {
            const selection = window.getSelection();
            let lineCount = 1; // Default to 1

            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const rects = range.getClientRects();
                
                // Get all unique y-coordinates of the rectangles
                const uniqueYPositions = new Set();
                for (const rect of rects) {
                    uniqueYPositions.add(Math.round(rect.top)); // Round to handle minor pixel differences
                }
                
                lineCount = uniqueYPositions.size;

                // Get the cell containing the selection
                const cell = range.commonAncestorContainer.nodeType === 1 
                    ? range.commonAncestorContainer.closest('td')
                    : range.commonAncestorContainer.parentElement.closest('td');

                if (cell) {
                    const row = cell.closest('tr');
                    const shotCell = row.querySelector('td:nth-child(2)');
                    
                    // Adjust the position of text boxes in the Shot column
                    if (shotCell) {
                        const lineHeight = 24; // CSS line height
                        const offset = (lineCount - 1) * lineHeight; // Calc offset
                        
                        // Make shot row and highlighted cut line up (Move text box down)
                        const cameraType = shotCell.querySelector('.cameraType');
                        if (cameraType) {
                            cameraType.style.marginTop = `${offset}px`;
                        }
                    }
                }
            }

            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const cell = range.commonAncestorContainer.nodeType === 1 
                ? range.commonAncestorContainer.closest('td')
                : range.commonAncestorContainer.parentElement.closest('td');
                
            if (!cell || cell.cellIndex !== 2) return;

            const selectedText = selection.toString();
            const existingCutLine = cell.querySelector('.cut-line');

            function createCutLine(text) {
                const span = document.createElement('span');
                span.className = 'cut-line';
                span.textContent = text;
                return span;
            }

            function addSlashAfter(element) {
                const textNode = document.createTextNode(" / ");
                element.after(textNode);
                return textNode;
            }

            function moveCursorAfter(node) {
                const newRange = document.createRange();
                newRange.setStartAfter(node);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }

            if (existingCutLine) {
                showQuestionModal(
                    "Replace or Add to new event?", //question
                    "Replace", //option 1
                    "Add to new event", //option 2

                    //REPLACE
                    function() {
                      var selection = window.getSelection();
                      var range = selection.getRangeAt(0);
                      var newText = selection.toString();
                      // Removes the '/' cut within the highlight
                      newText = newText.replace(/ \/ /g, ' ').trim();           

                      // Get the cell containing the selection
                      const cell = range.commonAncestorContainer.nodeType === 1 
                          ? range.commonAncestorContainer.closest('td')
                          : range.commonAncestorContainer.parentElement.closest('td');
                      
                      // Find and remove the existing cut line
                      const existingCutLine = cell.querySelector('.cut-line');
                      if (existingCutLine) {
                        // Remove the cut line and the following slash
                        const nextNode = existingCutLine.nextSibling;
                        if (nextNode && nextNode.nodeType === Node.TEXT_NODE && nextNode.textContent.includes('/')) {
                          nextNode.remove();
                        }
                        existingCutLine.remove();
                      }

                      // Create the new cut line span
                      const newLineSpan = document.createElement('span');
                      newLineSpan.className = 'cut-line';
                      newLineSpan.textContent = newText;

                      // Replace only the selected content
                      range.deleteContents();
                      range.insertNode(newLineSpan);
                      
                      // Add the slash after the new span
                      const slashText = document.createTextNode(' / ');
                      newLineSpan.after(slashText);

                      // Move cursor after the slash
                      const newRange = document.createRange();
                      newRange.setStartAfter(slashText);
                      newRange.collapse(true);
                      selection.removeAllRanges();
                      selection.addRange(newRange);
                    },
                    //ADD TO NEW EVENT
                    function() {
                        const selectedText = selection.toString();

                        $('.addEvent-button').trigger('click');
                        updateEventNumbers();

                        const newRow = cell.closest('tr').nextElementSibling;
                        const newScriptCell = newRow.cells[2];

                        const cutLineSpan = createCutLine(selectedText);
                        newScriptCell.appendChild(cutLineSpan);
                        addSlashAfter(cutLineSpan);

                        range.deleteContents();
                        if (cell.textContent.trim() === '') {
                            cell.textContent = '';
                        }
                    }
                );
            } else {
                try {
                    const newSpan = createCutLine(selectedText);
                    range.deleteContents();
                    range.insertNode(newSpan);
                    const textNode = addSlashAfter(newSpan);
                    moveCursorAfter(textNode);
                } catch (e) {
                    console.log("Could not add cut line: Selection may be invalid");
                }
            }
        });

        //UNDO
        $('.undo-button').on('click', function() {
          document.execCommand('undo', false, null);
        });

        //REDO
        $('.redo-button').on('click', function() {
          document.execCommand('redo', false, null);
        });

        //TITLE
        $('.add-item-button').on('click', function() {
          document.execCommand('underline', false, null);
          document.execCommand('bold', false, null);
        });


        //VIEW MODE
        $('.view-button').on('click', function() {
            const tableClone = $('.container').clone();
            
            // Show dropdown as the selected value
            const originalSelects = $('.container .shot-type-select');
            tableClone.find('.shot-type-select').each(function(index) {
                const originalSelect = originalSelects.eq(index);
                const selectedText = originalSelect.find('option:selected').text();
                $(this).replaceWith($('<span>').text(selectedText));
            });
            
            // Make all contenteditable elements non-editable in view mode
            tableClone.find('[contenteditable="true"]').attr('contenteditable', 'false');
            
            // Create new window/tab and write content
            const viewWindow = window.open('', '_blank');
            viewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>View Mode</title>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
                    <style>
                        body { 
                            padding-top: 20px;
                        }
                        table {
                            width: 794px !important;
                            table-layout: fixed;
                            margin: 0 auto;
                        }  

                        td, th{
                            border: none !important;
                            outline: none !important;
                        }
                        .editable-cell,
                        .editable-text,
                        div[contenteditable] {
                            outline: none !important;
                            border: none !important;
                            min-height: 24px;
                        }
                        .shot-type-select {
                            border: none !important;
                            outline: none !important;
                            appearance: none;
                            background: none;
                            pointer-events: none;
                        }
                        .btn {
                            display: none;
                        }
                        .cut-line {
                            position: relative;
                        }
                        .cut-line::after {
                            content: '';
                            position: absolute;
                            left: -400px;
                            right: 0;
                            bottom: -3px;
                            height: 2px;
                            background-color: black;
                            z-index: 1;
                            pointer-events: none;
                        }
                        .shot-type-flex-container {
                            display: flex;
                            align-items: center;
                            gap: 2px; /* Add small gap for view mode */
                        }
                        .shot-type-text {
                            flex-grow: 1;
                            margin-left: 8px;
                        }
                        .shotTypeDropdown {
                            flex-shrink: 0;
                            margin-right: 4px; /* Add small margin to separate from subject */
                        }
                    </style>
                </head>
                <body>
                    ${tableClone.html()}
                </body>
                </html>
            `);
            
            // Remove the last column (the add/remove buttons)
            viewWindow.document.querySelectorAll('tr').forEach(row => {
                const lastCell = row.lastElementChild;
                if (lastCell) {
                    lastCell.remove();
                }
            });

            // Remove the text in the header
            viewWindow.document.querySelectorAll('th').forEach(header => {
                header.textContent = '';
            });
            
            viewWindow.document.close();
            });

            //SAVE
            $('.save-button').on('click', function() {
              
            });
      });

    // Pop up question modal
    function showQuestionModal(question, option1Text, option2Text, option1Callback, option2Callback) {
      const modalElement = document.getElementById('questionModal');
      const modal = new bootstrap.Modal(modalElement);
      
      // Set the question
      document.querySelector('#questionModal .modal-body').textContent = question;
      
      // Set button text
      const option1Button = document.getElementById('modalOption1');
      const option2Button = document.getElementById('modalOption2');
      option1Button.textContent = option1Text;
      option2Button.textContent = option2Text;
      
      // Store the element that had focus before opening the modal
      const previousActiveElement = document.activeElement;
      
      // Set up button click handlers
      option1Button.onclick = function() {
        modal.hide();
        option1Callback();
        // Return focus to the previous element
        if (previousActiveElement) {
          previousActiveElement.focus();
        }
      };
      option2Button.onclick = function() {
        modal.hide();
        option2Callback();
        // Return focus to the previous element
        if (previousActiveElement) {
          previousActiveElement.focus();
        }
      };
      
      // Handle modal events
      modalElement.addEventListener('hidden.bs.modal', function () {
        // Return focus to the previous element when modal is hidden
        if (previousActiveElement) {
          previousActiveElement.focus();
        }
      }, { once: true });
      
      modal.show();
    }
  </script>
</body>
</html>       